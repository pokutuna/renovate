{"version":3,"file":"metadata.js","sourceRoot":"","sources":["../../lib/datasource/metadata.ts"],"names":[],"mappings":"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","sourcesContent":["import URL from 'url';\nimport is from '@sindresorhus/is';\nimport parse from 'github-url-from-git';\nimport * as hostRules from '../util/host-rules';\nimport { ReleaseResult } from './common';\n\n// Use this object to define changelog URLs for packages\n// Only necessary when the changelog data cannot be found in the package's source repository\nconst manualChangelogUrls = {\n  npm: {\n    'babel-preset-react-app':\n      'https://github.com/facebook/create-react-app/releases',\n    firebase: 'https://firebase.google.com/support/release-notes/js',\n    'flow-bin': 'https://github.com/facebook/flow/blob/master/Changelog.md',\n    gatsby:\n      'https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby/CHANGELOG.md',\n    'react-native':\n      'https://github.com/react-native-community/react-native-releases/blob/master/CHANGELOG.md',\n  },\n  pypi: {\n    django: 'https://github.com/django/django/tree/master/docs/releases',\n    djangorestframework:\n      'https://www.django-rest-framework.org/community/release-notes/',\n    flake8: 'http://flake8.pycqa.org/en/latest/release-notes/index.html',\n    'django-storages':\n      'https://github.com/jschneier/django-storages/blob/master/CHANGELOG.rst',\n    phonenumbers:\n      'https://github.com/daviddrysdale/python-phonenumbers/blob/dev/python/HISTORY.md',\n    'psycopg2-binary': 'http://initd.org/psycopg/articles/tag/release/',\n    'django-debug-toolbar':\n      'https://django-debug-toolbar.readthedocs.io/en/latest/changes.html',\n    'firebase-admin':\n      'https://firebase.google.com/support/release-notes/admin/python',\n    requests: 'https://github.com/psf/requests/blob/master/HISTORY.md',\n    wagtail: 'https://github.com/wagtail/wagtail/tree/master/docs/releases',\n  },\n  docker: {\n    'gitlab/gitlab-ce':\n      'https://gitlab.com/gitlab-org/omnibus-gitlab/-/blob/master/CHANGELOG.md',\n    'gitlab/gitlab-runner':\n      'https://gitlab.com/gitlab-org/gitlab-runner/-/blob/master/CHANGELOG.md',\n  },\n};\n\n// Use this object to define manual source URLs for packages\n// Only necessary if the datasource is unable to locate the source URL itself\nconst manualSourceUrls = {\n  orb: {\n    'cypress-io/cypress': 'https://github.com/cypress-io/circleci-orb',\n    'hutson/library-release-workflows':\n      'https://github.com/hyper-expanse/library-release-workflows',\n  },\n  docker: {\n    'gcr.io/kaniko-project/executor':\n      'https://github.com/GoogleContainerTools/kaniko',\n    'gitlab/gitlab-ce': 'https://gitlab.com/gitlab-org/omnibus-gitlab',\n    'gitlab/gitlab-runner': 'https://gitlab.com/gitlab-org/gitlab-runner',\n    node: 'https://github.com/nodejs/node',\n    traefik: 'https://github.com/containous/traefik',\n  },\n  kubernetes: {\n    node: 'https://github.com/nodejs/node',\n  },\n  npm: {\n    node: 'https://github.com/nodejs/node',\n  },\n  nvm: {\n    node: 'https://github.com/nodejs/node',\n  },\n  pypi: {\n    mkdocs: 'https://github.com/mkdocs/mkdocs',\n    mypy: 'https://github.com/python/mypy',\n  },\n};\n\n/* eslint-disable no-param-reassign */\nexport function addMetaData(\n  dep?: ReleaseResult,\n  datasource?: string,\n  lookupName?: string\n): void {\n  if (!dep) {\n    return;\n  }\n  const lookupNameLowercase = lookupName ? lookupName.toLowerCase() : null;\n  if (manualChangelogUrls[datasource]?.[lookupNameLowercase]) {\n    dep.changelogUrl = manualChangelogUrls[datasource][lookupNameLowercase];\n  }\n  if (manualSourceUrls[datasource]?.[lookupNameLowercase]) {\n    dep.sourceUrl = manualSourceUrls[datasource][lookupNameLowercase];\n  }\n\n  /**\n   * @param {string} url\n   */\n  const massageGithubUrl = (url: string): string => {\n    return url\n      .replace('http:', 'https:')\n      .replace(/^git:\\/?\\/?/, 'https://')\n      .replace('www.github.com', 'github.com')\n      .split('/')\n      .slice(0, 5)\n      .join('/');\n  };\n  /**\n   * @param {string} url\n   */\n  const massageGitlabUrl = (url: string): string => {\n    return url\n      .replace('http:', 'https:')\n      .replace(/^git:\\/?\\/?/, 'https://')\n      .replace(/\\/tree\\/.*$/i, '')\n      .replace(/\\/$/i, '')\n      .replace('.git', '');\n  };\n\n  if (\n    dep.changelogUrl?.includes('github.com') && // lgtm [js/incomplete-url-substring-sanitization]\n    !dep.sourceUrl\n  ) {\n    dep.sourceUrl = dep.changelogUrl;\n  }\n  // prettier-ignore\n  if (dep.homepage?.includes('github.com')) { // lgtm [js/incomplete-url-substring-sanitization]\n    if (!dep.sourceUrl) {\n      dep.sourceUrl = dep.homepage;\n    }\n    delete dep.homepage;\n  }\n  const extraBaseUrls = [];\n  // istanbul ignore next\n  hostRules.hosts({ hostType: 'github' }).forEach((host) => {\n    extraBaseUrls.push(host, `gist.${host}`);\n  });\n  extraBaseUrls.push('gitlab.com');\n  if (dep.sourceUrl) {\n    const parsedUrl = URL.parse(dep.sourceUrl);\n    if (parsedUrl?.hostname) {\n      let massagedUrl;\n      if (parsedUrl.hostname.includes('gitlab')) {\n        massagedUrl = massageGitlabUrl(dep.sourceUrl);\n      } else {\n        massagedUrl = massageGithubUrl(dep.sourceUrl);\n      }\n      // try massaging it\n      dep.sourceUrl =\n        parse(massagedUrl, {\n          extraBaseUrls,\n        }) || dep.sourceUrl;\n    } else {\n      delete dep.sourceUrl;\n    }\n  }\n\n  // Clean up any empty urls\n  const urls = ['homepage', 'sourceUrl', 'changelogUrl'];\n  for (const url of urls) {\n    if (is.nonEmptyString(dep[url])) {\n      dep[url] = dep[url].trim();\n      // istanbul ignore if\n      if (!dep[url].match(/^https?:\\/\\//)) {\n        delete dep[url];\n      }\n    } else {\n      delete dep[url];\n    }\n  }\n}\n"]}