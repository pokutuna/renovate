{"version":3,"file":"auth.js","sourceRoot":"","sources":["../../../lib/util/http/auth.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { NormalizedOptions } from 'got';\nimport {\n  PLATFORM_TYPE_GITEA,\n  PLATFORM_TYPE_GITHUB,\n  PLATFORM_TYPE_GITLAB,\n} from '../../constants/platforms';\nimport { GotOptions } from './types';\n\nexport function applyAuthorization(inOptions: GotOptions): GotOptions {\n  const options = { ...inOptions };\n  if (options.headers?.authorization) {\n    return options;\n  }\n  if (options.token) {\n    if (options.hostType === PLATFORM_TYPE_GITEA) {\n      options.headers.authorization = `token ${options.token}`;\n    } else if (options.hostType === PLATFORM_TYPE_GITHUB) {\n      options.headers.authorization = `token ${options.token}`;\n      if (options.token.startsWith('x-access-token:')) {\n        const appToken = options.token.replace('x-access-token:', '');\n        options.headers.authorization = `token ${appToken}`;\n        if (is.string(options.headers.accept)) {\n          options.headers.accept = options.headers.accept.replace(\n            'application/vnd.github.v3+json',\n            'application/vnd.github.machine-man-preview+json'\n          );\n        }\n      }\n    } else if (options.hostType === PLATFORM_TYPE_GITLAB) {\n      options.headers['Private-token'] = options.token;\n    } else {\n      options.headers.authorization = `Bearer ${options.token}`;\n    }\n    delete options.token;\n  } else if (options.password) {\n    // Otherwise got will add username and password to url and header\n    const auth = Buffer.from(\n      `${options.username || ''}:${options.password}`\n    ).toString('base64');\n    options.headers.authorization = `Basic ${auth}`;\n    delete options.username;\n    delete options.password;\n  }\n  return options;\n}\n\n// isAmazon return true if request options contains Amazon related headers\nfunction isAmazon(options: NormalizedOptions): boolean {\n  return options.search?.includes('X-Amz-Algorithm');\n}\n\n// isAzureBlob return true if request options contains Azure container registry related data\nfunction isAzureBlob(options: NormalizedOptions): boolean {\n  return (\n    options.hostname?.endsWith('.blob.core.windows.net') && // lgtm [js/incomplete-url-substring-sanitization]\n    options.href?.includes('/docker/registry')\n  );\n}\n\n// removeAuthorization from the redirect options\nexport function removeAuthorization(options: NormalizedOptions): void {\n  if (!options.password && !options.headers?.authorization) {\n    return;\n  }\n\n  // Check if request has been redirected to Amazon or an Azure blob (ACR)\n  if (isAmazon(options) || isAzureBlob(options)) {\n    // if there is no port in the redirect URL string, then delete it from the redirect options.\n    // This can be evaluated for removal after upgrading to Got v10\n    const portInUrl = options.href.split('/')[2].split(':')[1];\n    // istanbul ignore next\n    if (!portInUrl) {\n      // eslint-disable-next-line no-param-reassign\n      delete options.port; // Redirect will instead use 80 or 443 for HTTP or HTTPS respectively\n    }\n\n    // registry is hosted on Amazon or Azure blob, redirect url includes\n    // authentication which is not required and should be removed\n    delete options.headers.authorization; // eslint-disable-line no-param-reassign\n    delete options.username; // eslint-disable-line no-param-reassign\n    delete options.password; // eslint-disable-line no-param-reassign\n  }\n}\n"]}