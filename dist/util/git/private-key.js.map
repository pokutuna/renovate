{"version":3,"file":"private-key.js","sourceRoot":"","sources":["../../../lib/util/git/private-key.ts"],"names":[],"mappings":";;;;;;AAAA,4CAAoB;AACpB,gDAAwB;AACxB,wDAA0B;AAC1B,mEAAqE;AACrE,yCAAsC;AACtC,kCAA+B;AAE/B,IAAI,aAAqB,CAAC;AAC1B,IAAI,KAAa,CAAC;AAElB,SAAgB,aAAa,CAAC,GAAW;IACvC,aAAa,GAAG,GAAG,CAAC;AACtB,CAAC;AAFD,sCAEC;AAED,KAAK,UAAU,SAAS;IACtB,IAAI,KAAK,EAAE;QACT,OAAO;KACR;IACD,MAAM,WAAW,GAAG,cAAI,CAAC,IAAI,CAAC,YAAE,CAAC,MAAM,EAAE,GAAG,kBAAkB,CAAC,CAAC;IAChE,MAAM,kBAAE,CAAC,UAAU,CAAC,WAAW,EAAE,aAAa,CAAC,CAAC;IAChD,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,WAAI,CAAC,gBAAgB,WAAW,EAAE,CAAC,CAAC;IACrE,eAAM,CAAC,KAAK,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,EAAE,2BAA2B,CAAC,CAAC;IAC9D,KAAK,GAAG,CAAC,MAAM,GAAG,MAAM,CAAC;SACtB,KAAK,CAAC,IAAI,CAAC;SACX,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,qBAAqB,CAAC,CAAC;SACpD,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC;SACxB,KAAK,CAAC,GAAG,CAAC;SACV,KAAK,EAAE,CAAC;IACX,MAAM,kBAAE,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;AAC/B,CAAC;AAEM,KAAK,UAAU,eAAe,CAAC,GAAW;IAC/C,IAAI,CAAC,aAAa,EAAE;QAClB,OAAO;KACR;IACD,eAAM,CAAC,KAAK,CAAC,yBAAyB,CAAC,CAAC;IACxC,IAAI;QACF,MAAM,SAAS,EAAE,CAAC;QAClB,MAAM,WAAI,CAAC,8BAA8B,KAAK,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,CAAC;QAC3D,MAAM,WAAI,CAAC,gCAAgC,EAAE,EAAE,GAAG,EAAE,CAAC,CAAC;KACvD;IAAC,OAAO,GAAG,EAAE;QACZ,eAAM,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,EAAE,+BAA+B,CAAC,CAAC;QACtD,MAAM,IAAI,KAAK,CAAC,oCAAmB,CAAC,CAAC;KACtC;AACH,CAAC;AAbD,0CAaC","sourcesContent":["import os from 'os';\nimport path from 'path';\nimport fs from 'fs-extra';\nimport { PLATFORM_GPG_FAILED } from '../../constants/error-messages';\nimport { logger } from '../../logger';\nimport { exec } from '../exec';\n\nlet gitPrivateKey: string;\nlet keyId: string;\n\nexport function setPrivateKey(key: string): void {\n  gitPrivateKey = key;\n}\n\nasync function importKey(): Promise<void> {\n  if (keyId) {\n    return;\n  }\n  const keyFileName = path.join(os.tmpdir() + '/git-private.key');\n  await fs.outputFile(keyFileName, gitPrivateKey);\n  const { stdout, stderr } = await exec(`gpg --import ${keyFileName}`);\n  logger.debug({ stdout, stderr }, 'Private key import result');\n  keyId = (stdout + stderr)\n    .split('\\n')\n    .find((line) => line.includes('secret key imported'))\n    .replace('gpg: key ', '')\n    .split(':')\n    .shift();\n  await fs.remove(keyFileName);\n}\n\nexport async function writePrivateKey(cwd: string): Promise<void> {\n  if (!gitPrivateKey) {\n    return;\n  }\n  logger.debug('Setting git private key');\n  try {\n    await importKey();\n    await exec(`git config user.signingkey ${keyId}`, { cwd });\n    await exec(`git config commit.gpgsign true`, { cwd });\n  } catch (err) {\n    logger.warn({ err }, 'Error writing git private key');\n    throw new Error(PLATFORM_GPG_FAILED);\n  }\n}\n"]}