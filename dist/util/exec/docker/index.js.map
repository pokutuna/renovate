{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/util/exec/docker/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { SYSTEM_INSUFFICIENT_MEMORY } from '../../../constants/error-messages';\nimport { getPkgReleases } from '../../../datasource';\nimport { logger } from '../../../logger';\nimport * as versioning from '../../../versioning';\nimport {\n  DockerOptions,\n  ExecConfig,\n  Opt,\n  VolumeOption,\n  VolumesPair,\n  rawExec,\n} from '../common';\n\nconst prefetchedImages = new Set<string>();\n\nasync function prefetchDockerImage(taggedImage: string): Promise<void> {\n  if (prefetchedImages.has(taggedImage)) {\n    logger.debug(`Docker image is already prefetched: ${taggedImage}`);\n  } else {\n    logger.debug(`Fetching Docker image: ${taggedImage}`);\n    prefetchedImages.add(taggedImage);\n    await rawExec(`docker pull ${taggedImage}`, { encoding: 'utf-8' });\n    logger.debug(`Finished fetching Docker image`);\n  }\n}\n\nexport function resetPrefetchedImages(): void {\n  prefetchedImages.clear();\n}\n\nfunction expandVolumeOption(x: VolumeOption): VolumesPair | null {\n  if (typeof x === 'string') {\n    return [x, x];\n  }\n  if (Array.isArray(x) && x.length === 2) {\n    const [from, to] = x;\n    if (typeof from === 'string' && typeof to === 'string') {\n      return [from, to];\n    }\n  }\n  return null;\n}\n\nfunction volumesEql(x: VolumesPair, y: VolumesPair): boolean {\n  const [xFrom, xTo] = x;\n  const [yFrom, yTo] = y;\n  return xFrom === yFrom && xTo === yTo;\n}\n\nfunction uniq<T = unknown>(\n  array: T[],\n  eql = (x: T, y: T): boolean => x === y\n): T[] {\n  return array.filter((x, idx, arr) => {\n    return arr.findIndex((y) => eql(x, y)) === idx;\n  });\n}\n\nfunction prepareVolumes(volumes: VolumeOption[] = []): string[] {\n  const expanded: (VolumesPair | null)[] = volumes.map(expandVolumeOption);\n  const filtered: VolumesPair[] = expanded.filter((vol) => vol !== null);\n  const unique: VolumesPair[] = uniq<VolumesPair>(filtered, volumesEql);\n  return unique.map(([from, to]) => {\n    return `-v \"${from}\":\"${to}\"`;\n  });\n}\n\nfunction prepareCommands(commands: Opt<string>[]): string[] {\n  return commands.filter((command) => command && typeof command === 'string');\n}\n\nasync function getDockerTag(\n  depName: string,\n  constraint: string,\n  scheme: string\n): Promise<string> {\n  // TODO: fixme\n  // eslint-disable-next-line @typescript-eslint/unbound-method\n  const { isValid, isVersion, matches, sortVersions } = versioning.get(scheme);\n\n  if (!isValid(constraint)) {\n    logger.warn({ constraint }, `Invalid ${scheme} version constraint`);\n    return 'latest';\n  }\n\n  logger.debug(\n    { constraint },\n    `Found ${scheme} version constraint - checking for a compatible ${depName} image to use`\n  );\n  const imageReleases = await getPkgReleases({ datasource: 'docker', depName });\n  if (imageReleases?.releases) {\n    let versions = imageReleases.releases.map((release) => release.version);\n    versions = versions.filter(\n      (version) => isVersion(version) && matches(version, constraint)\n    );\n    versions = versions.sort(sortVersions);\n    if (versions.length) {\n      const version = versions.pop();\n      logger.debug(\n        { constraint, version },\n        `Found compatible ${scheme} version`\n      );\n      return version;\n    }\n  } /* istanbul ignore next */ else {\n    logger.error(`No ${depName} releases found`);\n    return 'latest';\n  }\n  logger.warn(\n    { depName, constraint, scheme },\n    'Failed to find a tag satisfying constraint, using \"latest\" tag instead'\n  );\n  return 'latest';\n}\n\nfunction getContainerName(image: string): string {\n  return image.replace(/\\//g, '_');\n}\n\nexport async function removeDockerContainer(image): Promise<void> {\n  const containerName = getContainerName(image);\n  let cmd = `docker ps --filter name=${containerName} -aq`;\n  try {\n    const res = await rawExec(cmd, {\n      encoding: 'utf-8',\n    });\n    const containerId = res?.stdout?.trim() || '';\n    // istanbul ignore if\n    if (containerId.length) {\n      logger.debug({ containerId }, 'Removing container');\n      cmd = `docker rm -f ${containerId}`;\n      await rawExec(cmd, {\n        encoding: 'utf-8',\n      });\n    } else {\n      logger.trace({ image, containerName }, 'No running containers to remove');\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.trace({ err }, 'removeDockerContainer err');\n    logger.info(\n      { image, containerName, cmd },\n      'Could not remove Docker container'\n    );\n  }\n}\n\n// istanbul ignore next\nexport async function removeDanglingContainers(): Promise<void> {\n  try {\n    const res = await rawExec(`docker ps --filter label=renovate_child -aq`, {\n      encoding: 'utf-8',\n    });\n    if (res?.stdout?.trim().length) {\n      const containerIds = res.stdout\n        .trim()\n        .split('\\n')\n        .map((container) => container.trim())\n        .filter(Boolean);\n      logger.debug({ containerIds }, 'Removing dangling child containers');\n      await rawExec(`docker rm -f ${containerIds.join(' ')}`, {\n        encoding: 'utf-8',\n      });\n    } else {\n      logger.debug('No dangling containers to remove');\n    }\n  } catch (err) /* istanbul ignore next */ {\n    if (err.errno === 'ENOMEM') {\n      throw new Error(SYSTEM_INSUFFICIENT_MEMORY);\n    }\n    if (err.stderr?.includes('Cannot connect to the Docker daemon')) {\n      logger.info('No docker daemon found');\n    } else {\n      logger.warn({ err }, 'Error removing dangling containers');\n    }\n  }\n}\n\nexport async function generateDockerCommand(\n  commands: string[],\n  options: DockerOptions,\n  config: ExecConfig\n): Promise<string> {\n  const { image, envVars, cwd, tagScheme, tagConstraint } = options;\n  const volumes = options.volumes || [];\n  const preCommands = options.preCommands || [];\n  const postCommands = options.postCommands || [];\n  const { localDir, cacheDir, dockerUser } = config;\n\n  const result = ['docker run --rm'];\n  const containerName = getContainerName(image);\n  result.push(`--name=${containerName}`);\n  result.push(`--label=renovate_child`);\n  if (dockerUser) {\n    result.push(`--user=${dockerUser}`);\n  }\n\n  result.push(...prepareVolumes([localDir, cacheDir, ...volumes]));\n\n  if (envVars) {\n    result.push(\n      ...uniq(envVars)\n        .filter((x) => typeof x === 'string')\n        .map((e) => `-e ${e}`)\n    );\n  }\n\n  if (cwd) {\n    result.push(`-w \"${cwd}\"`);\n  }\n\n  let tag;\n  if (options.tag) {\n    tag = options.tag;\n  } else if (tagConstraint) {\n    const tagVersioning = tagScheme || 'semver';\n    tag = await getDockerTag(image, tagConstraint, tagVersioning);\n    logger.debug(\n      { image, tagConstraint, tagVersioning, tag },\n      'Resolved tag constraint'\n    );\n  } else {\n    logger.debug({ image }, 'No tag or tagConstraint specified');\n  }\n\n  const taggedImage = tag ? `${image}:${tag}` : `${image}`;\n  await prefetchDockerImage(taggedImage);\n  result.push(taggedImage);\n\n  const bashCommand = [\n    ...prepareCommands(preCommands),\n    ...commands,\n    ...prepareCommands(postCommands),\n  ].join(' && ');\n  result.push(`bash -l -c \"${bashCommand.replace(/\"/g, '\\\\\"')}\"`); // lgtm [js/incomplete-sanitization]\n\n  return result.join(' ');\n}\n"]}