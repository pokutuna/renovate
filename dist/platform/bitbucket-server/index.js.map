{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/platform/bitbucket-server/index.ts"],"names":[],"mappings":"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","sourcesContent":["import url, { URLSearchParams } from 'url';\nimport is from '@sindresorhus/is';\nimport delay from 'delay';\nimport { RenovateConfig } from '../../config/common';\nimport {\n  REPOSITORY_CHANGED,\n  REPOSITORY_DISABLED,\n  REPOSITORY_NOT_FOUND,\n} from '../../constants/error-messages';\nimport { PLATFORM_TYPE_BITBUCKET_SERVER } from '../../constants/platforms';\nimport { PR_STATE_ALL, PR_STATE_OPEN } from '../../constants/pull-requests';\nimport { logger } from '../../logger';\nimport { BranchStatus } from '../../types';\nimport * as git from '../../util/git';\nimport * as hostRules from '../../util/host-rules';\nimport { HttpResponse } from '../../util/http';\nimport {\n  BitbucketServerHttp,\n  setBaseUrl,\n} from '../../util/http/bitbucket-server';\nimport { sanitize } from '../../util/sanitize';\nimport { ensureTrailingSlash } from '../../util/url';\nimport {\n  BranchStatusConfig,\n  CreatePRConfig,\n  EnsureCommentConfig,\n  EnsureCommentRemovalConfig,\n  EnsureIssueConfig,\n  EnsureIssueResult,\n  FindPRConfig,\n  Issue,\n  PlatformParams,\n  PlatformResult,\n  Pr,\n  RepoParams,\n  RepoResult,\n  VulnerabilityAlert,\n} from '../common';\nimport { smartTruncate } from '../utils/pr-body';\nimport { BbbsRestPr, BbsConfig, BbsPr, BbsRestUserRef } from './types';\nimport * as utils from './utils';\nimport { PartialDeep } from 'type-fest';\n/*\n * Version: 5.3 (EOL Date: 15 Aug 2019)\n * See following docs for api information:\n * https://docs.atlassian.com/bitbucket-server/rest/5.3.0/bitbucket-rest.html\n * https://docs.atlassian.com/bitbucket-server/rest/5.3.0/bitbucket-build-rest.html\n *\n * See following page for uptodate supported versions\n * https://confluence.atlassian.com/support/atlassian-support-end-of-life-policy-201851003.html#AtlassianSupportEndofLifePolicy-BitbucketServer\n */\n\nlet config: BbsConfig = {} as any;\n\nconst bitbucketServerHttp = new BitbucketServerHttp();\n\nconst defaults: any = {\n  hostType: PLATFORM_TYPE_BITBUCKET_SERVER,\n};\n\n/* istanbul ignore next */\nfunction updatePrVersion(pr: number, version: number): number {\n  const res = Math.max(config.prVersions.get(pr) || 0, version);\n  config.prVersions.set(pr, res);\n  return res;\n}\n\nexport function initPlatform({\n  endpoint,\n  username,\n  password,\n}: PlatformParams): Promise<PlatformResult> {\n  if (!endpoint) {\n    throw new Error('Init: You must configure a Bitbucket Server endpoint');\n  }\n  if (!(username && password)) {\n    throw new Error(\n      'Init: You must configure a Bitbucket Server username/password'\n    );\n  }\n  // TODO: Add a connection check that endpoint/username/password combination are valid\n  defaults.endpoint = ensureTrailingSlash(endpoint);\n  setBaseUrl(defaults.endpoint);\n  const platformConfig: PlatformResult = {\n    endpoint: defaults.endpoint,\n  };\n  return Promise.resolve(platformConfig);\n}\n\n// Get all repositories that the user has access to\nexport async function getRepos(): Promise<string[]> {\n  logger.debug('Autodiscovering Bitbucket Server repositories');\n  try {\n    const repos = await utils.accumulateValues(\n      `./rest/api/1.0/repos?permission=REPO_WRITE&state=AVAILABLE`\n    );\n    const result = repos.map(\n      (r: { project: { key: string }; slug: string }) =>\n        `${r.project.key.toLowerCase()}/${r.slug}`\n    );\n    logger.debug({ result }, 'result of getRepos()');\n    return result;\n  } catch (err) /* istanbul ignore next */ {\n    logger.error({ err }, `bitbucket getRepos error`);\n    throw err;\n  }\n}\n\n// Initialize GitLab by getting base branch\nexport async function initRepo({\n  repository,\n  localDir,\n  optimizeForDisabled,\n  bbUseDefaultReviewers,\n}: RepoParams): Promise<RepoResult> {\n  logger.debug(\n    `initRepo(\"${JSON.stringify({ repository, localDir }, null, 2)}\")`\n  );\n  const opts = hostRules.find({\n    hostType: defaults.hostType,\n    url: defaults.endpoint,\n  });\n\n  const [projectKey, repositorySlug] = repository.split('/');\n\n  if (optimizeForDisabled) {\n    interface RenovateConfig {\n      enabled: boolean;\n    }\n\n    interface FileData {\n      isLastPage: boolean;\n\n      lines: string[];\n\n      size: number;\n    }\n\n    let renovateConfig: RenovateConfig;\n    try {\n      const { body } = await bitbucketServerHttp.getJson<FileData>(\n        `./rest/api/1.0/projects/${projectKey}/repos/${repositorySlug}/browse/renovate.json?limit=20000`\n      );\n      if (!body.isLastPage) {\n        logger.warn('Renovate config to big: ' + body.size);\n      } else {\n        renovateConfig = JSON.parse(body.lines.join());\n      }\n    } catch {\n      // Do nothing\n    }\n    if (renovateConfig && renovateConfig.enabled === false) {\n      throw new Error(REPOSITORY_DISABLED);\n    }\n  }\n\n  config = {\n    projectKey,\n    repositorySlug,\n    repository,\n    prVersions: new Map<number, number>(),\n    username: opts.username,\n  } as any;\n\n  /* istanbul ignore else */\n  if (bbUseDefaultReviewers !== false) {\n    logger.debug('Enable bitbucket default reviewer');\n    config.bbUseDefaultReviewers = true;\n  }\n\n  const { host, pathname } = url.parse(defaults.endpoint!);\n  const gitUrl = git.getUrl({\n    protocol: defaults.endpoint!.split(':')[0],\n    auth: `${opts.username}:${opts.password}`,\n    host: `${host}${pathname}${\n      pathname.endsWith('/') ? '' : /* istanbul ignore next */ '/'\n    }scm`,\n    repository,\n  });\n\n  await git.initRepo({\n    ...config,\n    localDir,\n    url: gitUrl,\n    gitAuthorName: global.gitAuthor?.name,\n    gitAuthorEmail: global.gitAuthor?.email,\n  });\n\n  try {\n    const info = (\n      await bitbucketServerHttp.getJson<{\n        project: { key: string };\n        parent: string;\n      }>(\n        `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}`\n      )\n    ).body;\n    config.owner = info.project.key;\n    logger.debug(`${repository} owner = ${config.owner}`);\n    const defaultBranch = (\n      await bitbucketServerHttp.getJson<{ displayId: string }>(\n        `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/branches/default`\n      )\n    ).body.displayId;\n    config.mergeMethod = 'merge';\n    const repoConfig: RepoResult = {\n      defaultBranch,\n      isFork: !!info.parent,\n    };\n    return repoConfig;\n  } catch (err) /* istanbul ignore next */ {\n    logger.debug(err);\n    if (err.statusCode === 404) {\n      throw new Error(REPOSITORY_NOT_FOUND);\n    }\n    logger.debug({ err }, 'Unknown Bitbucket initRepo error');\n    throw err;\n  }\n}\n\nexport async function getRepoForceRebase(): Promise<boolean> {\n  logger.debug(`getRepoForceRebase()`);\n\n  // https://docs.atlassian.com/bitbucket-server/rest/7.0.1/bitbucket-rest.html#idp342\n  const res = await bitbucketServerHttp.getJson<{\n    mergeConfig: { defaultStrategy: { id: string } };\n  }>(\n    `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/settings/pull-requests`\n  );\n\n  // If the default merge strategy contains `ff-only` the PR can only be merged\n  // if it is up to date with the base branch.\n  // The current options for id are:\n  // no-ff, ff, ff-only, rebase-no-ff, rebase-ff-only, squash, squash-ff-only\n  return Boolean(\n    res.body?.mergeConfig?.defaultStrategy?.id.includes('ff-only')\n  );\n}\n\nexport async function setBaseBranch(branchName: string): Promise<string> {\n  const baseBranchSha = await git.setBranch(branchName);\n  return baseBranchSha;\n}\n\n// Gets details for a PR\nexport async function getPr(\n  prNo: number,\n  refreshCache?: boolean\n): Promise<BbsPr | null> {\n  logger.debug(`getPr(${prNo})`);\n  if (!prNo) {\n    return null;\n  }\n\n  const res = await bitbucketServerHttp.getJson<BbbsRestPr>(\n    `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}`,\n    { useCache: !refreshCache }\n  );\n\n  const pr: BbsPr = {\n    displayNumber: `Pull Request #${res.body.id}`,\n    ...utils.prInfo(res.body),\n    reviewers: res.body.reviewers.map((r) => r.user.name),\n  };\n  pr.hasReviewers = is.nonEmptyArray(pr.reviewers);\n  pr.version = updatePrVersion(pr.number, pr.version);\n\n  if (pr.state === PR_STATE_OPEN) {\n    const mergeRes = await bitbucketServerHttp.getJson<{\n      conflicted: string;\n      canMerge: string;\n    }>(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/merge`,\n      { useCache: !refreshCache }\n    );\n    pr.isConflicted = !!mergeRes.body.conflicted;\n    pr.canMerge = !!mergeRes.body.canMerge;\n  }\n\n  return pr;\n}\n\n// TODO: coverage\n// istanbul ignore next\nfunction matchesState(state: string, desiredState: string): boolean {\n  if (desiredState === PR_STATE_ALL) {\n    return true;\n  }\n  if (desiredState.startsWith('!')) {\n    return state !== desiredState.substring(1);\n  }\n  return state === desiredState;\n}\n\n// TODO: coverage\n// istanbul ignore next\nconst isRelevantPr = (\n  branchName: string,\n  prTitle: string | null | undefined,\n  state: string\n) => (p: Pr): boolean =>\n  p.branchName === branchName &&\n  (!prTitle || p.title === prTitle) &&\n  matchesState(p.state, state);\n\n// TODO: coverage\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nexport async function getPrList(_args?: any): Promise<Pr[]> {\n  logger.debug(`getPrList()`);\n  // istanbul ignore next\n  if (!config.prList) {\n    const query = new URLSearchParams({\n      state: 'ALL',\n      'role.1': 'AUTHOR',\n      'username.1': config.username,\n    }).toString();\n    const values = await utils.accumulateValues(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests?${query}`\n    );\n\n    config.prList = values.map(utils.prInfo);\n    logger.debug({ length: config.prList.length }, 'Retrieved Pull Requests');\n  } else {\n    logger.debug('returning cached PR list');\n  }\n  return config.prList;\n}\n\n// TODO: coverage\n// istanbul ignore next\nexport async function findPr({\n  branchName,\n  prTitle,\n  state = PR_STATE_ALL,\n  refreshCache,\n}: FindPRConfig): Promise<Pr | null> {\n  logger.debug(`findPr(${branchName}, \"${prTitle}\", \"${state}\")`);\n  const prList = await getPrList({ refreshCache });\n  const pr = prList.find(isRelevantPr(branchName, prTitle, state));\n  if (pr) {\n    logger.debug(`Found PR #${pr.number}`);\n  } else {\n    logger.debug(`DID NOT Found PR from branch #${branchName}`);\n  }\n  return pr;\n}\n\n// Returns the Pull Request for a branch. Null if not exists.\nexport async function getBranchPr(branchName: string): Promise<BbsPr | null> {\n  logger.debug(`getBranchPr(${branchName})`);\n  const existingPr = await findPr({\n    branchName,\n    state: PR_STATE_OPEN,\n  });\n  return existingPr ? getPr(existingPr.number) : null;\n}\n\n// istanbul ignore next\nexport async function refreshPr(number: number): Promise<void> {\n  // wait for pr change propagation\n  await delay(1000);\n  // refresh cache\n  await getPr(number, true);\n}\n\nexport async function deleteBranch(\n  branchName: string,\n  closePr = false\n): Promise<void> {\n  logger.debug(`deleteBranch(${branchName}, closePr=${closePr})`);\n  // TODO: coverage\n  // istanbul ignore next\n  if (closePr) {\n    // getBranchPr\n    const pr = await getBranchPr(branchName);\n    if (pr) {\n      const { body } = await bitbucketServerHttp.postJson<{ version: number }>(\n        `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${pr.number}/decline?version=${pr.version}`\n      );\n\n      updatePrVersion(pr.number, body.version);\n    }\n  }\n  return git.deleteBranch(branchName);\n}\n\nasync function getStatus(\n  branchName: string,\n  useCache = true\n): Promise<utils.BitbucketCommitStatus> {\n  const branchCommit = await git.getBranchCommit(branchName);\n\n  return (\n    await bitbucketServerHttp.getJson<utils.BitbucketCommitStatus>(\n      `./rest/build-status/1.0/commits/stats/${branchCommit}`,\n      {\n        useCache,\n      }\n    )\n  ).body;\n}\n\n// Returns the combined status for a branch.\n// umbrella for status checks\n// https://docs.atlassian.com/bitbucket-server/rest/6.0.0/bitbucket-build-rest.html#idp2\nexport async function getBranchStatus(\n  branchName: string,\n  requiredStatusChecks?: string[] | null\n): Promise<BranchStatus> {\n  logger.debug(\n    `getBranchStatus(${branchName}, requiredStatusChecks=${!!requiredStatusChecks})`\n  );\n\n  if (!requiredStatusChecks) {\n    // null means disable status checks, so it always succeeds\n    logger.debug('Status checks disabled = returning \"success\"');\n    return BranchStatus.green;\n  }\n\n  if (!(await git.branchExists(branchName))) {\n    throw new Error(REPOSITORY_CHANGED);\n  }\n\n  try {\n    const commitStatus = await getStatus(branchName);\n\n    logger.debug({ commitStatus }, 'branch status check result');\n\n    if (commitStatus.failed > 0) {\n      return BranchStatus.red;\n    }\n    if (commitStatus.inProgress > 0) {\n      return BranchStatus.yellow;\n    }\n    return commitStatus.successful > 0\n      ? BranchStatus.green\n      : BranchStatus.yellow;\n  } catch (err) {\n    logger.warn({ err }, `Failed to get branch status`);\n    return BranchStatus.red;\n  }\n}\n\nasync function getStatusCheck(\n  branchName: string,\n  useCache = true\n): Promise<utils.BitbucketStatus[]> {\n  const branchCommit = await git.getBranchCommit(branchName);\n\n  return utils.accumulateValues(\n    `./rest/build-status/1.0/commits/${branchCommit}`,\n    'get',\n    { useCache }\n  );\n}\n\n// https://docs.atlassian.com/bitbucket-server/rest/6.0.0/bitbucket-build-rest.html#idp2\nexport async function getBranchStatusCheck(\n  branchName: string,\n  context: string\n): Promise<BranchStatus | null> {\n  logger.debug(`getBranchStatusCheck(${branchName}, context=${context})`);\n\n  try {\n    const states = await getStatusCheck(branchName);\n\n    for (const state of states) {\n      if (state.key === context) {\n        switch (state.state) {\n          case 'SUCCESSFUL':\n            return BranchStatus.green;\n          case 'INPROGRESS':\n            return BranchStatus.yellow;\n          case 'FAILED':\n          default:\n            return BranchStatus.red;\n        }\n      }\n    }\n  } catch (err) {\n    logger.warn({ err }, `Failed to check branch status`);\n  }\n  return null;\n}\n\nexport async function setBranchStatus({\n  branchName,\n  context,\n  description,\n  state,\n  url: targetUrl,\n}: BranchStatusConfig): Promise<void> {\n  logger.debug(`setBranchStatus(${branchName})`);\n\n  const existingStatus = await getBranchStatusCheck(branchName, context);\n  if (existingStatus === state) {\n    return;\n  }\n  logger.debug({ branch: branchName, context, state }, 'Setting branch status');\n\n  const branchCommit = await git.getBranchCommit(branchName);\n\n  try {\n    const body: any = {\n      key: context,\n      description,\n      url: targetUrl || 'https://renovatebot.com',\n    };\n\n    switch (state) {\n      case BranchStatus.green:\n        body.state = 'SUCCESSFUL';\n        break;\n      case BranchStatus.yellow:\n        body.state = 'INPROGRESS';\n        break;\n      case BranchStatus.red:\n      default:\n        body.state = 'FAILED';\n        break;\n    }\n\n    await bitbucketServerHttp.postJson(\n      `./rest/build-status/1.0/commits/${branchCommit}`,\n      { body }\n    );\n\n    // update status cache\n    await getStatus(branchName, false);\n    await getStatusCheck(branchName, false);\n  } catch (err) {\n    logger.warn({ err }, `Failed to set branch status`);\n  }\n}\n\n// Issue\n\n// function getIssueList() {\n//   logger.debug(`getIssueList()`);\n//   // TODO: Needs implementation\n//   // This is used by Renovate when creating its own issues, e.g. for deprecated package warnings, config error notifications, or \"dependencyDashboard\"\n//   // BB Server doesnt have issues\n//   return [];\n// }\n\nexport /* istanbul ignore next */ function findIssue(\n  title: string\n): Promise<Issue | null> {\n  logger.debug(`findIssue(${title})`);\n  // TODO: Needs implementation\n  // This is used by Renovate when creating its own issues, e.g. for deprecated package warnings, config error notifications, or \"dependencyDashboard\"\n  // BB Server doesnt have issues\n  return null;\n}\n\nexport /* istanbul ignore next */ function ensureIssue({\n  title,\n}: EnsureIssueConfig): Promise<EnsureIssueResult | null> {\n  logger.warn({ title }, 'Cannot ensure issue');\n  // TODO: Needs implementation\n  // This is used by Renovate when creating its own issues, e.g. for deprecated package warnings, config error notifications, or \"dependencyDashboard\"\n  // BB Server doesnt have issues\n  return null;\n}\n\nexport /* istanbul ignore next */ function getIssueList(): Promise<Issue[]> {\n  logger.debug(`getIssueList()`);\n  // TODO: Needs implementation\n  return Promise.resolve([]);\n}\n\nexport /* istanbul ignore next */ function ensureIssueClosing(\n  title: string\n): Promise<void> {\n  logger.debug(`ensureIssueClosing(${title})`);\n  // TODO: Needs implementation\n  // This is used by Renovate when creating its own issues, e.g. for deprecated package warnings, config error notifications, or \"dependencyDashboard\"\n  // BB Server doesnt have issues\n  return Promise.resolve();\n}\n\nexport function addAssignees(iid: number, assignees: string[]): Promise<void> {\n  logger.debug(`addAssignees(${iid}, ${assignees})`);\n  // TODO: Needs implementation\n  // Currently Renovate does \"Create PR\" and then \"Add assignee\" as a two-step process, with this being the second step.\n  // BB Server doesnt support assignees\n  return Promise.resolve();\n}\n\nexport async function addReviewers(\n  prNo: number,\n  reviewers: string[]\n): Promise<void> {\n  logger.debug(`Adding reviewers ${reviewers} to #${prNo}`);\n\n  try {\n    const pr = await getPr(prNo);\n    if (!pr) {\n      throw new Error(REPOSITORY_NOT_FOUND);\n    }\n\n    const reviewersSet = new Set([...pr.reviewers, ...reviewers]);\n\n    await bitbucketServerHttp.putJson(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}`,\n      {\n        body: {\n          title: pr.title,\n          version: pr.version,\n          reviewers: Array.from(reviewersSet).map((name) => ({\n            user: { name },\n          })),\n        },\n      }\n    );\n    await getPr(prNo, true);\n  } catch (err) {\n    if (err.statusCode === 404) {\n      throw new Error(REPOSITORY_NOT_FOUND);\n    } else if (err.statusCode === 409) {\n      throw new Error(REPOSITORY_CHANGED);\n    } else {\n      logger.fatal({ err }, `Failed to add reviewers ${reviewers} to #${prNo}`);\n      throw err;\n    }\n  }\n}\n\nexport function deleteLabel(issueNo: number, label: string): Promise<void> {\n  logger.debug(`deleteLabel(${issueNo}, ${label})`);\n  // TODO: Needs implementation\n  // Only used for the \"request Renovate to rebase a PR using a label\" feature\n  return Promise.resolve();\n}\n\ntype Comment = { text: string; id: number };\n\nasync function getComments(prNo: number): Promise<Comment[]> {\n  // GET /rest/api/1.0/projects/{projectKey}/repos/{repositorySlug}/pull-requests/{pullRequestId}/activities\n  let comments = await utils.accumulateValues(\n    `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/activities`\n  );\n\n  comments = comments\n    .filter(\n      (a: { action: string; commentAction: string }) =>\n        a.action === 'COMMENTED' && a.commentAction === 'ADDED'\n    )\n    .map((a: { comment: Comment }) => a.comment);\n\n  logger.debug(`Found ${comments.length} comments`);\n\n  return comments;\n}\n\nasync function addComment(prNo: number, text: string): Promise<void> {\n  // POST /rest/api/1.0/projects/{projectKey}/repos/{repositorySlug}/pull-requests/{pullRequestId}/comments\n  await bitbucketServerHttp.postJson(\n    `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/comments`,\n    {\n      body: { text },\n    }\n  );\n}\n\nasync function getCommentVersion(\n  prNo: number,\n  commentId: number\n): Promise<number> {\n  // GET /rest/api/1.0/projects/{projectKey}/repos/{repositorySlug}/pull-requests/{pullRequestId}/comments/{commentId}\n  const { version } = (\n    await bitbucketServerHttp.getJson<{ version: number }>(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/comments/${commentId}`\n    )\n  ).body;\n\n  return version;\n}\n\nasync function editComment(\n  prNo: number,\n  commentId: number,\n  text: string\n): Promise<void> {\n  const version = await getCommentVersion(prNo, commentId);\n\n  // PUT /rest/api/1.0/projects/{projectKey}/repos/{repositorySlug}/pull-requests/{pullRequestId}/comments/{commentId}\n  await bitbucketServerHttp.putJson(\n    `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/comments/${commentId}`,\n    {\n      body: { text, version },\n    }\n  );\n}\n\nasync function deleteComment(prNo: number, commentId: number): Promise<void> {\n  const version = await getCommentVersion(prNo, commentId);\n\n  // DELETE /rest/api/1.0/projects/{projectKey}/repos/{repositorySlug}/pull-requests/{pullRequestId}/comments/{commentId}\n  await bitbucketServerHttp.deleteJson(\n    `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/comments/${commentId}?version=${version}`\n  );\n}\n\nexport async function ensureComment({\n  number,\n  topic,\n  content,\n}: EnsureCommentConfig): Promise<boolean> {\n  const sanitizedContent = sanitize(content);\n  try {\n    const comments = await getComments(number);\n    let body: string;\n    let commentId: number | undefined;\n    let commentNeedsUpdating: boolean | undefined;\n    if (topic) {\n      logger.debug(`Ensuring comment \"${topic}\" in #${number}`);\n      body = `### ${topic}\\n\\n${sanitizedContent}`;\n      comments.forEach((comment) => {\n        if (comment.text.startsWith(`### ${topic}\\n\\n`)) {\n          commentId = comment.id;\n          commentNeedsUpdating = comment.text !== body;\n        }\n      });\n    } else {\n      logger.debug(`Ensuring content-only comment in #${number}`);\n      body = `${sanitizedContent}`;\n      comments.forEach((comment) => {\n        if (comment.text === body) {\n          commentId = comment.id;\n          commentNeedsUpdating = false;\n        }\n      });\n    }\n    if (!commentId) {\n      await addComment(number, body);\n      logger.info(\n        { repository: config.repository, prNo: number, topic },\n        'Comment added'\n      );\n    } else if (commentNeedsUpdating) {\n      await editComment(number, commentId, body);\n      logger.debug(\n        { repository: config.repository, prNo: number },\n        'Comment updated'\n      );\n    } else {\n      logger.debug('Comment is already update-to-date');\n    }\n    return true;\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error ensuring comment');\n    return false;\n  }\n}\n\nexport async function ensureCommentRemoval({\n  number: prNo,\n  topic,\n  content,\n}: EnsureCommentRemovalConfig): Promise<void> {\n  try {\n    logger.debug(\n      `Ensuring comment \"${topic || content}\" in #${prNo} is removed`\n    );\n    const comments = await getComments(prNo);\n\n    const byTopic = (comment: Comment): boolean =>\n      comment.text.startsWith(`### ${topic}\\n\\n`);\n    const byContent = (comment: Comment): boolean =>\n      comment.text.trim() === content;\n\n    let commentId: number | null = null;\n\n    if (topic) {\n      commentId = comments.find(byTopic)?.id;\n    } else if (content) {\n      commentId = comments.find(byContent)?.id;\n    }\n\n    if (commentId) {\n      await deleteComment(prNo, commentId);\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error ensuring comment removal');\n  }\n}\n\n// Pull Request\n\nconst escapeHash = (input: string): string =>\n  input ? input.replace(/#/g, '%23') : input;\n\nexport async function createPr({\n  branchName,\n  targetBranch,\n  prTitle: title,\n  prBody: rawDescription,\n}: CreatePRConfig): Promise<Pr> {\n  const description = sanitize(rawDescription);\n  logger.debug(`createPr(${branchName}, title=${title})`);\n  const base = targetBranch;\n  let reviewers: BbsRestUserRef[] = [];\n\n  /* istanbul ignore else */\n  if (config.bbUseDefaultReviewers) {\n    logger.debug(`fetching default reviewers`);\n    const { id } = (\n      await bitbucketServerHttp.getJson<{ id: number }>(\n        `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}`\n      )\n    ).body;\n\n    const defReviewers = (\n      await bitbucketServerHttp.getJson<{ name: string }[]>(\n        `./rest/default-reviewers/1.0/projects/${config.projectKey}/repos/${\n          config.repositorySlug\n        }/reviewers?sourceRefId=refs/heads/${escapeHash(\n          branchName\n        )}&targetRefId=refs/heads/${base}&sourceRepoId=${id}&targetRepoId=${id}`\n      )\n    ).body;\n\n    reviewers = defReviewers.map((u) => ({\n      user: { name: u.name },\n    }));\n  }\n\n  const body: PartialDeep<BbbsRestPr> = {\n    title,\n    description,\n    fromRef: {\n      id: `refs/heads/${branchName}`,\n    },\n    toRef: {\n      id: `refs/heads/${base}`,\n    },\n    reviewers,\n  };\n  let prInfoRes: HttpResponse<BbbsRestPr>;\n  try {\n    prInfoRes = await bitbucketServerHttp.postJson<BbbsRestPr>(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests`,\n      { body }\n    );\n  } catch (err) /* istanbul ignore next */ {\n    if (\n      err.body?.errors?.[0]?.exceptionName ===\n      'com.atlassian.bitbucket.pull.EmptyPullRequestException'\n    ) {\n      logger.debug(\n        'Empty pull request - deleting branch so it can be recreated next run'\n      );\n      await deleteBranch(branchName);\n      throw new Error(REPOSITORY_CHANGED);\n    }\n    throw err;\n  }\n\n  const pr: BbsPr = {\n    displayNumber: `Pull Request #${prInfoRes.body.id}`,\n    ...utils.prInfo(prInfoRes.body),\n  };\n\n  updatePrVersion(pr.number, pr.version);\n\n  // istanbul ignore if\n  if (config.prList) {\n    config.prList.push(pr);\n  }\n\n  return pr;\n}\n\nexport async function updatePr(\n  prNo: number,\n  title: string,\n  rawDescription: string\n): Promise<void> {\n  const description = sanitize(rawDescription);\n  logger.debug(`updatePr(${prNo}, title=${title})`);\n\n  try {\n    const pr = await getPr(prNo);\n    if (!pr) {\n      throw Object.assign(new Error(REPOSITORY_NOT_FOUND), { statusCode: 404 });\n    }\n\n    const { body } = await bitbucketServerHttp.putJson<{ version: number }>(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}`,\n      {\n        body: {\n          title,\n          description,\n          version: pr.version,\n          reviewers: pr.reviewers.map((name: string) => ({ user: { name } })),\n        },\n      }\n    );\n\n    updatePrVersion(prNo, body.version);\n  } catch (err) {\n    if (err.statusCode === 404) {\n      throw new Error(REPOSITORY_NOT_FOUND);\n    } else if (err.statusCode === 409) {\n      throw new Error(REPOSITORY_CHANGED);\n    } else {\n      logger.fatal({ err }, `Failed to update PR`);\n      throw err;\n    }\n  }\n}\n\n// https://docs.atlassian.com/bitbucket-server/rest/6.0.0/bitbucket-rest.html#idp261\nexport async function mergePr(\n  prNo: number,\n  branchName: string\n): Promise<boolean> {\n  logger.debug(`mergePr(${prNo}, ${branchName})`);\n  // Used for \"automerge\" feature\n  try {\n    const pr = await getPr(prNo);\n    if (!pr) {\n      throw Object.assign(new Error(REPOSITORY_NOT_FOUND), { statusCode: 404 });\n    }\n    const { body } = await bitbucketServerHttp.postJson<{ version: number }>(\n      `./rest/api/1.0/projects/${config.projectKey}/repos/${config.repositorySlug}/pull-requests/${prNo}/merge?version=${pr.version}`\n    );\n    updatePrVersion(prNo, body.version);\n  } catch (err) {\n    if (err.statusCode === 404) {\n      throw new Error(REPOSITORY_NOT_FOUND);\n    } else if (err.statusCode === 409) {\n      logger.warn({ err }, `Failed to merge PR`);\n      return false;\n    } else {\n      logger.warn({ err }, `Failed to merge PR`);\n      return false;\n    }\n  }\n\n  logger.debug({ pr: prNo }, 'PR merged');\n  // Delete branch\n  await deleteBranch(branchName);\n  return true;\n}\n\nexport function getPrBody(input: string): string {\n  logger.debug(`getPrBody(${input.split('\\n')[0]})`);\n  // Remove any HTML we use\n  return smartTruncate(input, 30000)\n    .replace(\n      'you tick the rebase/retry checkbox',\n      'rename PR to start with \"rebase!\"'\n    )\n    .replace(/<\\/?summary>/g, '**')\n    .replace(/<\\/?details>/g, '')\n    .replace(new RegExp(`\\n---\\n\\n.*?<!-- rebase-check -->.*?(\\n|$)`), '')\n    .replace(new RegExp('<!--.*?-->', 'g'), '');\n}\n\nexport function getVulnerabilityAlerts(): Promise<VulnerabilityAlert[]> {\n  logger.debug(`getVulnerabilityAlerts()`);\n  return Promise.resolve([]);\n}\n"]}