{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/platform/bitbucket/index.ts"],"names":[],"mappings":"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","sourcesContent":["import URL from 'url';\nimport is from '@sindresorhus/is';\nimport parseDiff from 'parse-diff';\nimport { RenovateConfig } from '../../config/common';\nimport {\n  REPOSITORY_DISABLED,\n  REPOSITORY_NOT_FOUND,\n} from '../../constants/error-messages';\nimport { PLATFORM_TYPE_BITBUCKET } from '../../constants/platforms';\nimport { PR_STATE_ALL, PR_STATE_OPEN } from '../../constants/pull-requests';\nimport { logger } from '../../logger';\nimport { BranchStatus } from '../../types';\nimport * as git from '../../util/git';\nimport * as hostRules from '../../util/host-rules';\nimport { BitbucketHttp, setBaseUrl } from '../../util/http/bitbucket';\nimport { sanitize } from '../../util/sanitize';\nimport {\n  BranchStatusConfig,\n  CreatePRConfig,\n  EnsureCommentConfig,\n  EnsureCommentRemovalConfig,\n  EnsureIssueConfig,\n  EnsureIssueResult,\n  FindPRConfig,\n  Issue,\n  PlatformParams,\n  PlatformResult,\n  Pr,\n  RepoParams,\n  RepoResult,\n  VulnerabilityAlert,\n} from '../common';\nimport { smartTruncate } from '../utils/pr-body';\nimport { readOnlyIssueBody } from '../utils/read-only-issue-body';\nimport * as comments from './comments';\nimport * as utils from './utils';\n\nconst bitbucketHttp = new BitbucketHttp();\n\nconst BITBUCKET_PROD_ENDPOINT = 'https://api.bitbucket.org/';\n\nlet config: utils.Config = {} as any;\n\nlet endpoint_ = BITBUCKET_PROD_ENDPOINT;\n\nexport function initPlatform({\n  endpoint,\n  username,\n  password,\n}: PlatformParams): Promise<PlatformResult> {\n  if (!(username && password)) {\n    throw new Error(\n      'Init: You must configure a Bitbucket username and password'\n    );\n  }\n  if (endpoint && endpoint !== BITBUCKET_PROD_ENDPOINT) {\n    logger.warn(\n      `Init: Bitbucket Cloud endpoint should generally be ${BITBUCKET_PROD_ENDPOINT} but is being configured to a different value. Did you mean to use Bitbucket Server?`\n    );\n    endpoint_ = endpoint;\n  }\n  setBaseUrl(endpoint_);\n  // TODO: Add a connection check that endpoint/username/password combination are valid\n  const platformConfig: PlatformResult = {\n    endpoint: endpoint || BITBUCKET_PROD_ENDPOINT,\n  };\n  return Promise.resolve(platformConfig);\n}\n\n// Get all repositories that the user has access to\nexport async function getRepos(): Promise<string[]> {\n  logger.debug('Autodiscovering Bitbucket Cloud repositories');\n  try {\n    const repos = await utils.accumulateValues<{ full_name: string }>(\n      `/2.0/repositories/?role=contributor`\n    );\n    return repos.map((repo) => repo.full_name);\n  } catch (err) /* istanbul ignore next */ {\n    logger.error({ err }, `bitbucket getRepos error`);\n    throw err;\n  }\n}\n\n// Initialize bitbucket by getting base branch and SHA\nexport async function initRepo({\n  repository,\n  localDir,\n  optimizeForDisabled,\n  bbUseDefaultReviewers,\n}: RepoParams): Promise<RepoResult> {\n  logger.debug(`initRepo(\"${repository}\")`);\n  const opts = hostRules.find({\n    hostType: PLATFORM_TYPE_BITBUCKET,\n    url: endpoint_,\n  });\n  config = {\n    repository,\n    username: opts.username,\n    bbUseDefaultReviewers: bbUseDefaultReviewers !== false,\n  } as any;\n  let info: utils.RepoInfo;\n  try {\n    info = utils.repoInfoTransformer(\n      (await bitbucketHttp.getJson(`/2.0/repositories/${repository}`)).body\n    );\n\n    if (optimizeForDisabled) {\n      interface RenovateConfig {\n        enabled: boolean;\n      }\n\n      let renovateConfig: RenovateConfig;\n      try {\n        renovateConfig = (\n          await bitbucketHttp.getJson<RenovateConfig>(\n            `/2.0/repositories/${repository}/src/${info.mainbranch}/renovate.json`\n          )\n        ).body;\n      } catch {\n        // Do nothing\n      }\n      if (renovateConfig && renovateConfig.enabled === false) {\n        throw new Error(REPOSITORY_DISABLED);\n      }\n    }\n\n    Object.assign(config, {\n      owner: info.owner,\n      mergeMethod: info.mergeMethod,\n      has_issues: info.has_issues,\n    });\n\n    logger.debug(`${repository} owner = ${config.owner}`);\n  } catch (err) /* istanbul ignore next */ {\n    if (err.statusCode === 404) {\n      throw new Error(REPOSITORY_NOT_FOUND);\n    }\n    logger.debug({ err }, 'Unknown Bitbucket initRepo error');\n    throw err;\n  }\n\n  const { hostname } = URL.parse(endpoint_);\n\n  // Converts API hostnames to their respective HTTP git hosts:\n  // `api.bitbucket.org`  to `bitbucket.org`\n  // `api-staging.<host>` to `staging.<host>`\n  const hostnameWithoutApiPrefix = /api[.|-](.+)/.exec(hostname)[1];\n\n  const url = git.getUrl({\n    protocol: 'https',\n    auth: `${opts.username}:${opts.password}`,\n    hostname: hostnameWithoutApiPrefix,\n    repository,\n  });\n\n  await git.initRepo({\n    ...config,\n    localDir,\n    url,\n    gitAuthorName: global.gitAuthor?.name,\n    gitAuthorEmail: global.gitAuthor?.email,\n  });\n  const repoConfig: RepoResult = {\n    defaultBranch: info.mainbranch,\n    isFork: info.isFork,\n  };\n  return repoConfig;\n}\n\n// Returns true if repository has rule enforcing PRs are up-to-date with base branch before merging\nexport function getRepoForceRebase(): Promise<boolean> {\n  // BB doesnt have an option to flag staled branches\n  return Promise.resolve(false);\n}\n\nexport async function setBaseBranch(branchName: string): Promise<string> {\n  const baseBranchSha = await git.setBranch(branchName);\n  return baseBranchSha;\n}\n\n// istanbul ignore next\nfunction matchesState(state: string, desiredState: string): boolean {\n  if (desiredState === PR_STATE_ALL) {\n    return true;\n  }\n  if (desiredState.startsWith('!')) {\n    return state !== desiredState.substring(1);\n  }\n  return state === desiredState;\n}\n\nexport async function getPrList(): Promise<Pr[]> {\n  logger.debug('getPrList()');\n  if (!config.prList) {\n    logger.debug('Retrieving PR list');\n    let url = `/2.0/repositories/${config.repository}/pullrequests?`;\n    url += utils.prStates.all.map((state) => 'state=' + state).join('&');\n    const prs = await utils.accumulateValues(url, undefined, undefined, 50);\n    config.prList = prs.map(utils.prInfo);\n    logger.debug({ length: config.prList.length }, 'Retrieved Pull Requests');\n  }\n  return config.prList;\n}\n\nexport async function findPr({\n  branchName,\n  prTitle,\n  state = PR_STATE_ALL,\n}: FindPRConfig): Promise<Pr | null> {\n  logger.debug(`findPr(${branchName}, ${prTitle}, ${state})`);\n  const prList = await getPrList();\n  const pr = prList.find(\n    (p) =>\n      p.branchName === branchName &&\n      (!prTitle || p.title === prTitle) &&\n      matchesState(p.state, state)\n  );\n  if (pr) {\n    logger.debug(`Found PR #${pr.number}`);\n  }\n  return pr;\n}\n\nexport async function deleteBranch(\n  branchName: string,\n  closePr?: boolean\n): Promise<void> {\n  if (closePr) {\n    const pr = await findPr({ branchName, state: PR_STATE_OPEN });\n    if (pr) {\n      await bitbucketHttp.postJson(\n        `/2.0/repositories/${config.repository}/pullrequests/${pr.number}/decline`\n      );\n    }\n  }\n  return git.deleteBranch(branchName);\n}\n\nasync function isPrConflicted(prNo: number): Promise<boolean> {\n  const diff = (\n    await bitbucketHttp.get(\n      `/2.0/repositories/${config.repository}/pullrequests/${prNo}/diff`\n    )\n  ).body;\n\n  return utils.isConflicted(parseDiff(diff));\n}\n\ninterface PrResponse {\n  id: string;\n  state: string;\n  links: {\n    commits: {\n      href: string;\n    };\n  };\n  source: {\n    branch: {\n      name: string;\n    };\n  };\n  reviewers: Array<any>;\n}\n\n// Gets details for a PR\nexport async function getPr(prNo: number): Promise<Pr | null> {\n  const pr = (\n    await bitbucketHttp.getJson<PrResponse>(\n      `/2.0/repositories/${config.repository}/pullrequests/${prNo}`\n    )\n  ).body;\n\n  // istanbul ignore if\n  if (!pr) {\n    return null;\n  }\n\n  const res: any = {\n    displayNumber: `Pull Request #${pr.id}`,\n    ...utils.prInfo(pr),\n  };\n\n  if (utils.prStates.open.includes(pr.state)) {\n    res.isConflicted = await isPrConflicted(prNo);\n\n    // TODO: Is that correct? Should we check getBranchStatus like gitlab?\n    res.canMerge = !res.isConflicted;\n  }\n  res.hasReviewers = is.nonEmptyArray(pr.reviewers);\n\n  return res;\n}\n\nconst escapeHash = (input: string): string =>\n  input ? input.replace(/#/g, '%23') : input;\n\ninterface BranchResponse {\n  target: {\n    hash: string;\n  };\n}\n\n// Return the commit SHA for a branch\nasync function getBranchCommit(branchName: string): Promise<string | null> {\n  try {\n    const branch = (\n      await bitbucketHttp.getJson<BranchResponse>(\n        `/2.0/repositories/${config.repository}/refs/branches/${escapeHash(\n          branchName\n        )}`\n      )\n    ).body;\n    return branch.target.hash;\n  } catch (err) /* istanbul ignore next */ {\n    logger.debug({ err }, `getBranchCommit('${branchName}') failed'`);\n    return null;\n  }\n}\n\n// Returns the Pull Request for a branch. Null if not exists.\nexport async function getBranchPr(branchName: string): Promise<Pr | null> {\n  logger.debug(`getBranchPr(${branchName})`);\n  const existingPr = await findPr({\n    branchName,\n    state: PR_STATE_OPEN,\n  });\n  return existingPr ? getPr(existingPr.number) : null;\n}\n\nasync function getStatus(\n  branchName: string,\n  useCache = true\n): Promise<utils.BitbucketStatus[]> {\n  const sha = await getBranchCommit(branchName);\n  return utils.accumulateValues<utils.BitbucketStatus>(\n    `/2.0/repositories/${config.repository}/commit/${sha}/statuses`,\n    'get',\n    { useCache }\n  );\n}\n// Returns the combined status for a branch.\nexport async function getBranchStatus(\n  branchName: string,\n  requiredStatusChecks?: string[]\n): Promise<BranchStatus> {\n  logger.debug(`getBranchStatus(${branchName})`);\n  if (!requiredStatusChecks) {\n    // null means disable status checks, so it always succeeds\n    logger.debug('Status checks disabled = returning \"success\"');\n    return BranchStatus.green;\n  }\n  if (requiredStatusChecks.length) {\n    // This is Unsupported\n    logger.warn({ requiredStatusChecks }, `Unsupported requiredStatusChecks`);\n    return BranchStatus.red;\n  }\n  const statuses = await getStatus(branchName);\n  logger.debug({ branch: branchName, statuses }, 'branch status check result');\n  if (!statuses.length) {\n    logger.debug('empty branch status check result = returning \"pending\"');\n    return BranchStatus.yellow;\n  }\n  const noOfFailures = statuses.filter(\n    (status: { state: string }) =>\n      status.state === 'FAILED' || status.state === 'STOPPED'\n  ).length;\n  if (noOfFailures) {\n    return BranchStatus.red;\n  }\n  const noOfPending = statuses.filter(\n    (status: { state: string }) => status.state === 'INPROGRESS'\n  ).length;\n  if (noOfPending) {\n    return BranchStatus.yellow;\n  }\n  return BranchStatus.green;\n}\n\nconst bbToRenovateStatusMapping: Record<string, BranchStatus> = {\n  SUCCESSFUL: BranchStatus.green,\n  INPROGRESS: BranchStatus.yellow,\n  FAILED: BranchStatus.red,\n};\n\nexport async function getBranchStatusCheck(\n  branchName: string,\n  context: string\n): Promise<BranchStatus | null> {\n  const statuses = await getStatus(branchName);\n  const bbState = (statuses.find((status) => status.key === context) || {})\n    .state;\n  return bbToRenovateStatusMapping[bbState] || null;\n}\n\nexport async function setBranchStatus({\n  branchName,\n  context,\n  description,\n  state,\n  url: targetUrl,\n}: BranchStatusConfig): Promise<void> {\n  const sha = await getBranchCommit(branchName);\n\n  // TargetUrl can not be empty so default to bitbucket\n  const url = targetUrl || /* istanbul ignore next */ 'http://bitbucket.org';\n\n  const body = {\n    name: context,\n    state: utils.buildStates[state],\n    key: context,\n    description,\n    url,\n  };\n\n  await bitbucketHttp.postJson(\n    `/2.0/repositories/${config.repository}/commit/${sha}/statuses/build`,\n    { body }\n  );\n  // update status cache\n  await getStatus(branchName, false);\n}\n\ntype BbIssue = { id: number; title: string; content?: { raw: string } };\n\nasync function findOpenIssues(title: string): Promise<BbIssue[]> {\n  try {\n    const filter = encodeURIComponent(\n      [\n        `title=${JSON.stringify(title)}`,\n        '(state = \"new\" OR state = \"open\")',\n        `reporter.username=\"${config.username}\"`,\n      ].join(' AND ')\n    );\n    return (\n      (\n        await bitbucketHttp.getJson<{ values: BbIssue[] }>(\n          `/2.0/repositories/${config.repository}/issues?q=${filter}`\n        )\n      ).body.values || /* istanbul ignore next */ []\n    );\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error finding issues');\n    return [];\n  }\n}\n\nexport async function findIssue(title: string): Promise<Issue> {\n  logger.debug(`findIssue(${title})`);\n\n  /* istanbul ignore if */\n  if (!config.has_issues) {\n    logger.debug('Issues are disabled - cannot findIssue');\n    return null;\n  }\n  const issues = await findOpenIssues(title);\n  if (!issues.length) {\n    return null;\n  }\n  const [issue] = issues;\n  return {\n    number: issue.id,\n    body: issue.content?.raw,\n  };\n}\n\nasync function closeIssue(issueNumber: number): Promise<void> {\n  await bitbucketHttp.putJson(\n    `/2.0/repositories/${config.repository}/issues/${issueNumber}`,\n    {\n      body: { state: 'closed' },\n    }\n  );\n}\n\nexport function getPrBody(input: string): string {\n  // Remove any HTML we use\n  return smartTruncate(input, 50000)\n    .replace(\n      'you tick the rebase/retry checkbox',\n      'rename PR to start with \"rebase!\"'\n    )\n    .replace(/<\\/?summary>/g, '**')\n    .replace(/<\\/?details>/g, '')\n    .replace(new RegExp(`\\n---\\n\\n.*?<!-- rebase-check -->.*?\\n`), '')\n    .replace(/\\]\\(\\.\\.\\/pull\\//g, '](../../pull-requests/');\n}\n\nexport async function ensureIssue({\n  title,\n  reuseTitle,\n  body,\n}: EnsureIssueConfig): Promise<EnsureIssueResult | null> {\n  logger.debug(`ensureIssue()`);\n  const description = getPrBody(sanitize(body));\n\n  /* istanbul ignore if */\n  if (!config.has_issues) {\n    logger.warn('Issues are disabled - cannot ensureIssue');\n    logger.debug({ title }, 'Failed to ensure Issue');\n    return null;\n  }\n  try {\n    let issues = await findOpenIssues(title);\n    if (!issues.length) {\n      issues = await findOpenIssues(reuseTitle);\n    }\n    if (issues.length) {\n      // Close any duplicates\n      for (const issue of issues.slice(1)) {\n        await closeIssue(issue.id);\n      }\n      const [issue] = issues;\n      if (\n        issue.title !== title ||\n        String(issue.content.raw).trim() !== description.trim()\n      ) {\n        logger.debug('Issue updated');\n        await bitbucketHttp.putJson(\n          `/2.0/repositories/${config.repository}/issues/${issue.id}`,\n          {\n            body: {\n              content: {\n                raw: readOnlyIssueBody(description),\n                markup: 'markdown',\n              },\n            },\n          }\n        );\n        return 'updated';\n      }\n    } else {\n      logger.info('Issue created');\n      await bitbucketHttp.postJson(\n        `/2.0/repositories/${config.repository}/issues`,\n        {\n          body: {\n            title,\n            content: {\n              raw: readOnlyIssueBody(description),\n              markup: 'markdown',\n            },\n          },\n        }\n      );\n      return 'created';\n    }\n  } catch (err) /* istanbul ignore next */ {\n    if (err.message.startsWith('Repository has no issue tracker.')) {\n      logger.debug(\n        `Issues are disabled, so could not create issue: ${err.message}`\n      );\n    } else {\n      logger.warn({ err }, 'Could not ensure issue');\n    }\n  }\n  return null;\n}\n\nexport /* istanbul ignore next */ async function getIssueList(): Promise<\n  Issue[]\n> {\n  logger.debug(`getIssueList()`);\n\n  /* istanbul ignore if */\n  if (!config.has_issues) {\n    logger.debug('Issues are disabled - cannot getIssueList');\n    return [];\n  }\n  try {\n    const filter = encodeURIComponent(\n      [\n        '(state = \"new\" OR state = \"open\")',\n        `reporter.username=\"${config.username}\"`,\n      ].join(' AND ')\n    );\n    return (\n      (\n        await bitbucketHttp.getJson<{ values: Issue[] }>(\n          `/2.0/repositories/${config.repository}/issues?q=${filter}`\n        )\n      ).body.values || /* istanbul ignore next */ []\n    );\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error finding issues');\n    return [];\n  }\n}\n\nexport async function ensureIssueClosing(title: string): Promise<void> {\n  /* istanbul ignore if */\n  if (!config.has_issues) {\n    logger.debug('Issues are disabled - cannot ensureIssueClosing');\n    return;\n  }\n  const issues = await findOpenIssues(title);\n  for (const issue of issues) {\n    await closeIssue(issue.id);\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nexport function addAssignees(\n  _prNr: number,\n  _assignees: string[]\n): Promise<void> {\n  // Bitbucket supports \"participants\" and \"reviewers\" so does not seem to have the concept of \"assignee\"\n  logger.warn('Cannot add assignees');\n  return Promise.resolve();\n}\n\nexport async function addReviewers(\n  prId: number,\n  reviewers: string[]\n): Promise<void> {\n  logger.debug(`Adding reviewers ${reviewers} to #${prId}`);\n\n  const { title } = await getPr(prId);\n\n  const body = {\n    title,\n    reviewers: reviewers.map((username: string) => ({ username })),\n  };\n\n  await bitbucketHttp.putJson(\n    `/2.0/repositories/${config.repository}/pullrequests/${prId}`,\n    {\n      body,\n    }\n  );\n}\n\nexport /* istanbul ignore next */ function deleteLabel(): never {\n  throw new Error('deleteLabel not implemented');\n}\n\nexport function ensureComment({\n  number,\n  topic,\n  content,\n}: EnsureCommentConfig): Promise<boolean> {\n  // https://developer.atlassian.com/bitbucket/api/2/reference/search?q=pullrequest+comment\n  return comments.ensureComment({\n    config,\n    number,\n    topic,\n    content: sanitize(content),\n  });\n}\n\nexport function ensureCommentRemoval({\n  number: prNo,\n  topic,\n  content,\n}: EnsureCommentRemovalConfig): Promise<void> {\n  return comments.ensureCommentRemoval(config, prNo, topic, content);\n}\n\n// Creates PR and returns PR number\nexport async function createPr({\n  branchName,\n  targetBranch,\n  prTitle: title,\n  prBody: description,\n}: CreatePRConfig): Promise<Pr> {\n  // labels is not supported in Bitbucket: https://bitbucket.org/site/master/issues/11976/ability-to-add-labels-to-pull-requests-bb\n\n  const base = targetBranch;\n\n  logger.debug({ repository: config.repository, title, base }, 'Creating PR');\n\n  let reviewers: { uuid: { raw: string } }[] = [];\n\n  if (config.bbUseDefaultReviewers) {\n    const reviewersResponse = (\n      await bitbucketHttp.getJson<utils.PagedResult<Reviewer>>(\n        `/2.0/repositories/${config.repository}/default-reviewers`\n      )\n    ).body;\n    reviewers = reviewersResponse.values.map((reviewer: Reviewer) => ({\n      uuid: reviewer.uuid,\n    }));\n  }\n\n  const body = {\n    title,\n    description: sanitize(description),\n    source: {\n      branch: {\n        name: branchName,\n      },\n    },\n    destination: {\n      branch: {\n        name: base,\n      },\n    },\n    close_source_branch: true,\n    reviewers,\n  };\n\n  try {\n    const prInfo = (\n      await bitbucketHttp.postJson<PrResponse>(\n        `/2.0/repositories/${config.repository}/pullrequests`,\n        {\n          body,\n        }\n      )\n    ).body;\n    // TODO: fix types\n    const pr: Pr = {\n      number: prInfo.id,\n      displayNumber: `Pull Request #${prInfo.id}`,\n    } as any;\n    // istanbul ignore if\n    if (config.prList) {\n      config.prList.push(pr);\n    }\n    return pr;\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error creating pull request');\n    throw err;\n  }\n}\n\ninterface Reviewer {\n  uuid: { raw: string };\n}\n\ninterface Commit {\n  author: { raw: string };\n}\n\nexport async function updatePr(\n  prNo: number,\n  title: string,\n  description: string\n): Promise<void> {\n  logger.debug(`updatePr(${prNo}, ${title}, body)`);\n  // Updating a PR in Bitbucket will clear the reviewers if reviewers is not present\n  const pr = (\n    await bitbucketHttp.getJson<PrResponse>(\n      `/2.0/repositories/${config.repository}/pullrequests/${prNo}`\n    )\n  ).body;\n\n  await bitbucketHttp.putJson(\n    `/2.0/repositories/${config.repository}/pullrequests/${prNo}`,\n    {\n      body: {\n        title,\n        description: sanitize(description),\n        reviewers: pr.reviewers,\n      },\n    }\n  );\n}\n\nexport async function mergePr(\n  prNo: number,\n  branchName: string\n): Promise<boolean> {\n  logger.debug(`mergePr(${prNo}, ${branchName})`);\n\n  try {\n    await bitbucketHttp.postJson(\n      `/2.0/repositories/${config.repository}/pullrequests/${prNo}/merge`,\n      {\n        body: {\n          close_source_branch: true,\n          merge_strategy: 'merge_commit',\n          message: 'auto merged',\n        },\n      }\n    );\n    logger.debug('Automerging succeeded');\n  } catch (err) /* istanbul ignore next */ {\n    return false;\n  }\n  return true;\n}\n\nexport function getVulnerabilityAlerts(): Promise<VulnerabilityAlert[]> {\n  return Promise.resolve([]);\n}\n"]}