{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../lib/manager/kustomize/extract.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,qCAAmC;AACnC,0EAA4D;AAC5D,6EAA+D;AAC/D,mFAAqE;AACrE,yCAAsC;AActC,mCAAmC;AACnC,MAAM,YAAY,GAAG,yCAAyC,CAAC;AAE/D,uDAAuD;AACvD,MAAM,UAAU,GAAG,wBAAwB,CAAC;AAE5C,MAAM,SAAS,GAAG,gGAAgG,CAAC;AAEnH,SAAgB,WAAW,CAAC,IAAY;IACtC,MAAM,WAAW,GAAG,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAEzC,IAAI,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,MAAM,EAAE;QACvB,MAAM,EAAE,YAAY,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,WAAW,CAAC,MAAM,CAAC;QAEjE,OAAO;YACL,UAAU,EAAE,oBAAoB,CAAC,EAAE;YACnC,OAAO;YACP,UAAU;YACV,YAAY;SACb,CAAC;KACH;IAED,MAAM,eAAe,GAAG,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAChD,IAAI,eAAe,EAAE;QACnB,MAAM,YAAY,GAAG,eAAe,CAAC,MAAM,CAAC,OAAO,CAAC;QACpD,MAAM,IAAI,GAAG,eAAe,CAAC,MAAM,CAAC,QAAQ,CAAC;QAE7C,MAAM,SAAS,GAAG,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACxC,IAAI,GAAG,GAAG,IAAI,CAAC;QACf,8CAA8C;QAC9C,IAAI,SAAS,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE;YACxC,GAAG,GAAG,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC;SAC5B;QAED,OAAO;YACL,UAAU,EAAE,iBAAiB,CAAC,EAAE;YAChC,OAAO,EAAE,IAAI;YACb,UAAU,EAAE,GAAG;YACf,YAAY;SACb,CAAC;KACH;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAnCD,kCAmCC;AAED,SAAgB,YAAY,CAAC,KAAY;IACvC,IAAI,CAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,IAAI,KAAI,KAAK,CAAC,MAAM,EAAE;QAC/B,OAAO;YACL,UAAU,EAAE,gBAAgB,CAAC,EAAE;YAC/B,OAAO,EAAE,KAAK,CAAC,IAAI;YACnB,UAAU,EAAE,KAAK,CAAC,IAAI;YACtB,YAAY,EAAE,KAAK,CAAC,MAAM;SAC3B,CAAC;KACH;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAXD,oCAWC;AAED,SAAgB,cAAc,CAAC,OAAe;IAC5C,IAAI,GAAG,GAAG,IAAI,CAAC;IACf,IAAI;QACF,GAAG,GAAG,kBAAQ,CAAC,OAAO,CAAC,CAAC;KACzB;IAAC,OAAO,CAAC,EAAE,0BAA0B,CAAC;QACrC,OAAO,IAAI,CAAC;KACb;IAED,IAAI,CAAC,GAAG,EAAE;QACR,OAAO,IAAI,CAAC;KACb;IAED,IAAI,GAAG,CAAC,IAAI,KAAK,eAAe,EAAE;QAChC,OAAO,IAAI,CAAC;KACb;IAED,GAAG,CAAC,KAAK,GAAG,CAAC,GAAG,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,SAAS,IAAI,EAAE,CAAC,CAAC;IAC1D,GAAG,CAAC,MAAM,GAAG,GAAG,CAAC,MAAM,IAAI,EAAE,CAAC;IAE9B,OAAO,GAAG,CAAC;AACb,CAAC;AApBD,wCAoBC;AAED,SAAgB,kBAAkB,CAAC,OAAe;IAChD,eAAM,CAAC,KAAK,CAAC,gCAAgC,CAAC,CAAC;IAC/C,MAAM,IAAI,GAAwB,EAAE,CAAC;IAErC,MAAM,GAAG,GAAG,cAAc,CAAC,OAAO,CAAC,CAAC;IACpC,IAAI,CAAC,GAAG,EAAE;QACR,OAAO,IAAI,CAAC;KACb;IAED,wBAAwB;IACxB,KAAK,MAAM,IAAI,IAAI,GAAG,CAAC,KAAK,EAAE;QAC5B,MAAM,GAAG,GAAG,WAAW,CAAC,IAAI,CAAC,CAAC;QAC9B,IAAI,GAAG,EAAE;YACP,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;SAChB;KACF;IAED,sBAAsB;IACtB,KAAK,MAAM,KAAK,IAAI,GAAG,CAAC,MAAM,EAAE;QAC9B,MAAM,GAAG,GAAG,YAAY,CAAC,KAAK,CAAC,CAAC;QAChC,IAAI,GAAG,EAAE;YACP,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;SAChB;KACF;IAED,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;QAChB,OAAO,IAAI,CAAC;KACb;IACD,OAAO,EAAE,IAAI,EAAE,CAAC;AAClB,CAAC;AA7BD,gDA6BC","sourcesContent":["import { safeLoad } from 'js-yaml';\nimport * as datasourceDocker from '../../datasource/docker';\nimport * as datasourceGitTags from '../../datasource/git-tags';\nimport * as datasourceGitHubTags from '../../datasource/github-tags';\nimport { logger } from '../../logger';\nimport { PackageDependency, PackageFile } from '../common';\n\ninterface Image {\n  name: string;\n  newTag: string;\n}\n\ninterface Kustomize {\n  kind: string;\n  bases: string[];\n  images: Image[];\n}\n\n// extract the version from the url\nconst versionMatch = /(?<basename>.*)\\?ref=(?<version>.*)\\s*$/;\n\n// extract the url from the base of a url with a subdir\nconst extractUrl = /^(?<url>.*)(?:\\/\\/.*)$/;\n\nconst githubUrl = /^github\\.com\\/(?<depName>(?<lookupName>[^/]+?\\/[^/]+?)(?:\\/[^/]+?)*)\\?ref=(?<currentValue>.+)$/;\n\nexport function extractBase(base: string): PackageDependency | null {\n  const githubMatch = githubUrl.exec(base);\n\n  if (githubMatch?.groups) {\n    const { currentValue, depName, lookupName } = githubMatch.groups;\n\n    return {\n      datasource: datasourceGitHubTags.id,\n      depName,\n      lookupName,\n      currentValue,\n    };\n  }\n\n  const basenameVersion = versionMatch.exec(base);\n  if (basenameVersion) {\n    const currentValue = basenameVersion.groups.version;\n    const root = basenameVersion.groups.basename;\n\n    const urlResult = extractUrl.exec(root);\n    let url = root;\n    // if a match, then there was a subdir, update\n    if (urlResult && !url.startsWith('http')) {\n      url = urlResult.groups.url;\n    }\n\n    return {\n      datasource: datasourceGitTags.id,\n      depName: root,\n      lookupName: url,\n      currentValue,\n    };\n  }\n\n  return null;\n}\n\nexport function extractImage(image: Image): PackageDependency | null {\n  if (image?.name && image.newTag) {\n    return {\n      datasource: datasourceDocker.id,\n      depName: image.name,\n      lookupName: image.name,\n      currentValue: image.newTag,\n    };\n  }\n\n  return null;\n}\n\nexport function parseKustomize(content: string): Kustomize | null {\n  let pkg = null;\n  try {\n    pkg = safeLoad(content);\n  } catch (e) /* istanbul ignore next */ {\n    return null;\n  }\n\n  if (!pkg) {\n    return null;\n  }\n\n  if (pkg.kind !== 'Kustomization') {\n    return null;\n  }\n\n  pkg.bases = (pkg.bases || []).concat(pkg.resources || []);\n  pkg.images = pkg.images || [];\n\n  return pkg;\n}\n\nexport function extractPackageFile(content: string): PackageFile | null {\n  logger.trace('kustomize.extractPackageFile()');\n  const deps: PackageDependency[] = [];\n\n  const pkg = parseKustomize(content);\n  if (!pkg) {\n    return null;\n  }\n\n  // grab the remote bases\n  for (const base of pkg.bases) {\n    const dep = extractBase(base);\n    if (dep) {\n      deps.push(dep);\n    }\n  }\n\n  // grab the image tags\n  for (const image of pkg.images) {\n    const dep = extractImage(image);\n    if (dep) {\n      deps.push(dep);\n    }\n  }\n\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}