{"version":3,"file":"package.js","sourceRoot":"","sources":["../../../lib/manager/travis/package.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,0DAAkC;AAClC,sEAAoC;AACpC,iDAAkD;AAClD,mFAAqE;AACrE,yCAAsC;AACtC,qCAAyC;AACzC,oDAA0E;AAmB1E,IAAI,QAAwB,CAAC;AAC7B,IAAI,WAAiB,CAAC;AAEtB,KAAK,UAAU,gBAAgB;IAC7B,MAAM,IAAI,GAAG,MAAM,kBAAW,CAAC,4BAA4B,CAAC,CAAC;IAC7D,MAAM,cAAc,GAAG,CAAC,wDAAa,IAAI,GAAC,CAAe,CAAC;IAC1D,QAAQ,GAAG;QACT,GAAG,EAAE,EAAE;QACP,GAAG,EAAE,EAAE;QACP,MAAM,EAAE,EAAE;QACV,UAAU,EAAE,EAAE;QACd,UAAU,EAAE,EAAE;QACd,OAAO,EAAE,EAAE;KACZ,CAAC;IAEF,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;IAEvB,KAAK,MAAM,CAAC,QAAQ,EAAE,IAAI,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE;QAC7D,MAAM,OAAO,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC;QACvE,IAAI,OAAO,EAAE;YACX,MAAM,OAAO,GAAG,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;YACzD,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC3B,MAAM,aAAa,GACjB,IAAI,CAAC,WAAW,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,GAAG,CAAC;YACvD,IAAI,CAAC,aAAa,EAAE;gBAClB,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;aAC/B;YACD,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC;YACnD,IAAI,KAAK,EAAE;gBACT,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gBAC3B,IAAI,CAAC,aAAa,EAAE;oBAClB,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;iBACnC;aACF;SACF;KACF;IACD,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;IACnE,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;IAEhE,OAAO,cAAc,CAAC;AACxB,CAAC;AAED,KAAK,UAAU,aAAa;IAC1B,IAAI,QAAQ,IAAI,WAAW,GAAG,IAAI,IAAI,EAAE,EAAE;QACxC,OAAO;KACR;IACD,MAAM,cAAc,GAAG,MAAM,gBAAgB,EAAE,CAAC;IAChD,WAAW,GAAG,IAAI,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,MAAM;IAC5C,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;IACvB,KAAK,MAAM,IAAI,IAAI,MAAM,CAAC,MAAM,CAAC,cAAc,CAAC,EAAE;QAChD,MAAM,MAAM,GAAG,CAAC,OAAO,EAAE,KAAK,EAAE,aAAa,EAAE,KAAK,CAAC,CAAC;QACtD,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE;YAC1B,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;YACxC,IAAI,SAAS,GAAG,GAAG,IAAI,SAAS,GAAG,WAAW,EAAE;gBAC9C,WAAW,GAAG,SAAS,CAAC;aACzB;SACF;KACF;IACD,eAAM,CAAC,KAAK,CAAC,iCAAiC,GAAG,WAAW,CAAC,CAAC;AAChE,CAAC;AAEM,KAAK,UAAU,iBAAiB,CACrC,MAA2B;IAE3B,eAAM,CAAC,KAAK,CAAC,4BAA4B,CAAC,CAAC;IAC3C,MAAM,EAAE,aAAa,EAAE,GAAG,MAAM,CAAC;IACjC,IAAI,EAAC,aAAa,aAAb,aAAa,uBAAb,aAAa,CAAE,MAAM,CAAA,EAAE;QAC1B,OAAO,EAAE,CAAC;KACX;IACD,MAAM,aAAa,EAAE,CAAC;IACtB,KAAK,MAAM,MAAM,IAAI,aAAa,EAAE;QAClC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;YAC3C,eAAM,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,EAAE,uBAAuB,CAAC,CAAC;YACjD,OAAO,EAAE,CAAC;SACX;KACF;IACD,eAAM,CAAC,KAAK,CAAC,EAAE,aAAa,EAAE,EAAE,eAAe,CAAC,CAAC;IACjD,IAAI,QAAQ,GAAW,aAA0C;SAC9D,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;SACjC,MAAM,CAAC,CAAC,MAAM,EAAE,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,CAAC;SACrD,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;IACzB,MAAM,QAAQ,GAAW,QAAQ,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;IACvD,IAAI,MAAM,CAAC,aAAa,KAAK,KAAK,IAAI,kBAAS,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,EAAE;QACvE,MAAM,QAAQ,GAAG,CACf,MAAM,2BAAc,CAAC;YACnB,GAAG,MAAM;YACT,UAAU,EAAE,oBAAoB,CAAC,EAAE;YACnC,OAAO,EAAE,aAAa;SACvB,CAAC,CACH,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;QAC7C,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAChC,6BAAoB,CAAC,QAAQ,EAAE,GAAG,KAAK,EAAE,CAAC,CAC3C,CAAC;KACH;IACD,IAAI,YAAE,CAAC,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,EAAE;QACrC,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,CAAC;KAC5C;IACD,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;IAE/B,2CAA2C;IAC1C,MAAM,CAAC,YAAoB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;IACnD,IAAI,yBAAK,CAAC,MAAM,CAAC,YAAY,EAAE,QAAQ,CAAC,EAAE;QACxC,OAAO,EAAE,CAAC;KACX;IACD,OAAO;QACL;YACE,QAAQ,EAAE,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC;YAC5B,QAAQ;YACR,OAAO,EAAE,IAAI;YACb,SAAS,EAAE,gCAAgC;SAC5C;KACF,CAAC;AACJ,CAAC;AAnDD,8CAmDC","sourcesContent":["import is from '@sindresorhus/is';\nimport equal from 'fast-deep-equal';\nimport { getPkgReleases } from '../../datasource';\nimport * as datasourceGithubTags from '../../datasource/github-tags';\nimport { logger } from '../../logger';\nimport { resolveFile } from '../../util';\nimport { isVersion, maxSatisfyingVersion } from '../../versioning/semver';\nimport { LookupUpdate, PackageUpdateConfig } from '../common';\n\ninterface NodeJsPolicies {\n  all: number[];\n  lts: number[];\n  active: number[];\n  lts_active: number[];\n  lts_latest: number[];\n  current: number[];\n}\ninterface NodeJsSchedule {\n  lts: string;\n  maintenance: string;\n  end: string;\n  start: string;\n}\ntype NodeJsData = Record<string, NodeJsSchedule>;\n\nlet policies: NodeJsPolicies;\nlet refreshDate: Date;\n\nasync function generatePolicies(): Promise<NodeJsData> {\n  const file = await resolveFile('data/node-js-schedule.json');\n  const nodeJsSchedule = (await import(file)) as NodeJsData;\n  policies = {\n    all: [],\n    lts: [],\n    active: [],\n    lts_active: [],\n    lts_latest: [],\n    current: [],\n  };\n\n  const now = new Date();\n\n  for (const [vRelease, data] of Object.entries(nodeJsSchedule)) {\n    const isAlive = new Date(data.start) < now && new Date(data.end) > now;\n    if (isAlive) {\n      const release = parseInt(vRelease.replace(/^v/, ''), 10);\n      policies.all.push(release);\n      const isMaintenance =\n        data.maintenance && new Date(data.maintenance) < now;\n      if (!isMaintenance) {\n        policies.active.push(release);\n      }\n      const isLts = data.lts && new Date(data.lts) < now;\n      if (isLts) {\n        policies.lts.push(release);\n        if (!isMaintenance) {\n          policies.lts_active.push(release);\n        }\n      }\n    }\n  }\n  policies.current.push(policies.active[policies.active.length - 1]);\n  policies.lts_latest.push(policies.lts[policies.lts.length - 1]);\n\n  return nodeJsSchedule;\n}\n\nasync function checkPolicies(): Promise<void> {\n  if (policies && refreshDate > new Date()) {\n    return;\n  }\n  const nodeJsSchedule = await generatePolicies();\n  refreshDate = new Date('3000-01-01'); // y3k\n  const now = new Date();\n  for (const data of Object.values(nodeJsSchedule)) {\n    const fields = ['start', 'lts', 'maintenance', 'end'];\n    for (const field of fields) {\n      const fieldDate = new Date(data[field]);\n      if (fieldDate > now && fieldDate < refreshDate) {\n        refreshDate = fieldDate;\n      }\n    }\n  }\n  logger.debug('Node.js policies refresh date: ' + refreshDate);\n}\n\nexport async function getPackageUpdates(\n  config: PackageUpdateConfig\n): Promise<LookupUpdate[]> {\n  logger.trace('travis.getPackageUpdates()');\n  const { supportPolicy } = config;\n  if (!supportPolicy?.length) {\n    return [];\n  }\n  await checkPolicies();\n  for (const policy of supportPolicy) {\n    if (!Object.keys(policies).includes(policy)) {\n      logger.warn({ policy }, `Unknown supportPolicy`);\n      return [];\n    }\n  }\n  logger.debug({ supportPolicy }, `supportPolicy`);\n  let newValue: any[] = (supportPolicy as (keyof NodeJsPolicies)[])\n    .map((policy) => policies[policy])\n    .reduce((result, policy) => result.concat(policy), [])\n    .sort((a, b) => a - b);\n  const newMajor: number = newValue[newValue.length - 1];\n  if (config.rangeStrategy === 'pin' || isVersion(config.currentValue[0])) {\n    const versions = (\n      await getPkgReleases({\n        ...config,\n        datasource: datasourceGithubTags.id,\n        depName: 'nodejs/node',\n      })\n    ).releases.map((release) => release.version);\n    newValue = newValue.map((value) =>\n      maxSatisfyingVersion(versions, `${value}`)\n    );\n  }\n  if (is.string(config.currentValue[0])) {\n    newValue = newValue.map((val) => `${val}`);\n  }\n  newValue.sort((a, b) => a - b);\n\n  // TODO: `config.currentValue` is a string!\n  (config.currentValue as any).sort((a, b) => a - b);\n  if (equal(config.currentValue, newValue)) {\n    return [];\n  }\n  return [\n    {\n      newValue: newValue.join(','),\n      newMajor,\n      isRange: true,\n      sourceUrl: 'https://github.com/nodejs/node',\n    },\n  ];\n}\n"]}