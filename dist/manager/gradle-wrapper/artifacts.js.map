{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../lib/manager/gradle-wrapper/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import { resolve } from 'path';\nimport { stat } from 'fs-extra';\nimport { logger } from '../../logger';\nimport { ExecOptions, exec } from '../../util/exec';\nimport { readLocalFile, writeLocalFile } from '../../util/fs';\nimport { StatusResult, getRepoStatus } from '../../util/git';\nimport { Http } from '../../util/http';\nimport { UpdateArtifact, UpdateArtifactsResult } from '../common';\nimport {\n  extraEnv,\n  gradleWrapperFileName,\n  prepareGradleCommand,\n} from '../gradle/utils';\n\nconst http = new Http('gradle-wrapper');\n\nasync function addIfUpdated(\n  status: StatusResult,\n  fileProjectPath: string\n): Promise<UpdateArtifactsResult | null> {\n  if (status.modified.includes(fileProjectPath)) {\n    return {\n      file: {\n        name: fileProjectPath,\n        contents: await readLocalFile(fileProjectPath),\n      },\n    };\n  }\n  return null;\n}\n\nfunction getDistributionUrl(newPackageFileContent: string): string {\n  const distributionUrlLine = newPackageFileContent\n    .split('\\n')\n    .find((line) => line.startsWith('distributionUrl='));\n  if (distributionUrlLine) {\n    return distributionUrlLine\n      .replace('distributionUrl=', '')\n      .replace('https\\\\:', 'https:');\n  }\n  return null;\n}\n\nasync function getDistributionChecksum(url: string): Promise<string> {\n  const { body } = await http.get(`${url}.sha256`);\n  return body;\n}\n\nexport async function updateArtifacts({\n  packageFileName,\n  newPackageFileContent,\n  updatedDeps,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  try {\n    const projectDir = config.localDir;\n    logger.debug({ updatedDeps }, 'gradle-wrapper.updateArtifacts()');\n    const gradlew = gradleWrapperFileName(config);\n    const gradlewPath = resolve(projectDir, `./${gradlew}`);\n    let cmd = await prepareGradleCommand(\n      gradlew,\n      projectDir,\n      await stat(gradlewPath).catch(() => null),\n      `wrapper`\n    );\n    if (!cmd) {\n      logger.info('No gradlew found - skipping Artifacts update');\n      return null;\n    }\n    const distributionUrl = getDistributionUrl(newPackageFileContent);\n    if (distributionUrl) {\n      cmd += ` --gradle-distribution-url ${distributionUrl}`;\n      if (newPackageFileContent.includes('distributionSha256Sum=')) {\n        // need to reset version, otherwise we have a checksum missmatch\n        await writeLocalFile(\n          packageFileName,\n          newPackageFileContent.replace(config.toVersion, config.currentValue)\n        );\n        const checksum = await getDistributionChecksum(distributionUrl);\n        cmd += ` --gradle-distribution-sha256-sum ${checksum}`;\n      }\n    } else {\n      cmd += ` --gradle-version ${config.toVersion}`;\n    }\n    logger.debug(`Updating gradle wrapper: \"${cmd}\"`);\n    const execOptions: ExecOptions = {\n      docker: {\n        image: 'renovate/gradle',\n      },\n      extraEnv,\n    };\n    try {\n      await exec(cmd, execOptions);\n    } catch (err) {\n      // TODO: Is this an artifact error?\n      logger.warn(\n        { err },\n        'Error executing gradle wrapper update command. It can be not a critical one though.'\n      );\n    }\n    const status = await getRepoStatus();\n    const artifactFileNames = [\n      'gradle/wrapper/gradle-wrapper.properties',\n      'gradle/wrapper/gradle-wrapper.jar',\n      'gradlew',\n      'gradlew.bat',\n    ].map(\n      (filename) =>\n        packageFileName\n          .replace('gradle/wrapper/', '')\n          .replace('gradle-wrapper.properties', '') + filename\n    );\n    const updateArtifactsResult = (\n      await Promise.all(\n        artifactFileNames.map((fileProjectPath) =>\n          addIfUpdated(status, fileProjectPath)\n        )\n      )\n    ).filter((e) => e != null);\n    logger.debug(\n      { files: updateArtifactsResult.map((r) => r.file.name) },\n      `Returning updated gradle-wrapper files`\n    );\n    return updateArtifactsResult;\n  } catch (err) {\n    logger.debug({ err }, 'Error setting new Gradle Wrapper release value');\n    return [\n      {\n        artifactError: {\n          lockFile: packageFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}