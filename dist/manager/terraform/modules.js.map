{"version":3,"file":"modules.js","sourceRoot":"","sources":["../../../lib/manager/terraform/modules.ts"],"names":[],"mappings":"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","sourcesContent":["import * as datasourceGitTags from '../../datasource/git-tags';\nimport * as datasourceGithubTags from '../../datasource/github-tags';\nimport * as datasourceTerraformModule from '../../datasource/terraform-module';\nimport { logger } from '../../logger';\nimport { SkipReason } from '../../types';\nimport { isVersion } from '../../versioning/hashicorp';\nimport { PackageDependency } from '../common';\nimport { extractTerraformProvider } from './providers';\nimport { ExtractionResult, TerraformDependencyTypes } from './util';\n\nconst githubRefMatchRegex = /github.com([/:])(?<project>[^/]+\\/[a-z0-9-.]+).*\\?ref=(?<tag>.*)$/;\nconst gitTagsRefMatchRegex = /(?:git::)?(?<url>(?:http|https|ssh):\\/\\/(?:.*@)?(?<path>.*.*\\/(?<project>.*\\/.*)))\\?ref=(?<tag>.*)$/;\nconst hostnameMatchRegex = /^(?<hostname>([\\w|\\d]+\\.)+[\\w|\\d]+)/;\n\nexport function extractTerraformModule(\n  startingLine: number,\n  lines: string[],\n  moduleName: string\n): ExtractionResult {\n  const result = extractTerraformProvider(startingLine, lines, moduleName);\n  result.dependencies.forEach((dep) => {\n    // eslint-disable-next-line no-param-reassign\n    dep.managerData.terraformDependencyType = TerraformDependencyTypes.module;\n  });\n  return result;\n}\n\nexport function analyseTerraformModule(dep: PackageDependency): void {\n  const githubRefMatch = githubRefMatchRegex.exec(dep.managerData.source);\n  const gitTagsRefMatch = gitTagsRefMatchRegex.exec(dep.managerData.source);\n  /* eslint-disable no-param-reassign */\n  if (githubRefMatch) {\n    const depNameShort = githubRefMatch.groups.project.replace(/\\.git$/, '');\n    dep.depType = 'github';\n    dep.depName = 'github.com/' + depNameShort;\n    dep.depNameShort = depNameShort;\n    dep.currentValue = githubRefMatch.groups.tag;\n    dep.datasource = datasourceGithubTags.id;\n    dep.lookupName = depNameShort;\n    if (!isVersion(dep.currentValue)) {\n      dep.skipReason = SkipReason.UnsupportedVersion;\n    }\n  } else if (gitTagsRefMatch) {\n    dep.depType = 'gitTags';\n    if (gitTagsRefMatch.groups.path.includes('//')) {\n      logger.debug('Terraform module contains subdirectory');\n      dep.depName = gitTagsRefMatch.groups.path.split('//')[0];\n      dep.depNameShort = dep.depName.split(/\\/(.+)/)[1];\n      const tempLookupName = gitTagsRefMatch.groups.url.split('//');\n      dep.lookupName = tempLookupName[0] + '//' + tempLookupName[1];\n    } else {\n      dep.depName = gitTagsRefMatch.groups.path.replace('.git', '');\n      dep.depNameShort = gitTagsRefMatch.groups.project.replace('.git', '');\n      dep.lookupName = gitTagsRefMatch.groups.url;\n    }\n    dep.currentValue = gitTagsRefMatch.groups.tag;\n    dep.datasource = datasourceGitTags.id;\n    if (!isVersion(dep.currentValue)) {\n      dep.skipReason = SkipReason.UnsupportedVersion;\n    }\n  } else if (dep.managerData.source) {\n    const moduleParts = dep.managerData.source.split('//')[0].split('/');\n    if (moduleParts[0] === '..') {\n      dep.skipReason = SkipReason.Local;\n    } else if (moduleParts.length >= 3) {\n      const hostnameMatch = hostnameMatchRegex.exec(dep.managerData.source);\n      if (hostnameMatch) {\n        dep.registryUrls = [`https://${hostnameMatch.groups.hostname}`];\n      }\n      dep.depType = 'terraform';\n      dep.depName = moduleParts.join('/');\n      dep.depNameShort = dep.depName;\n      dep.datasource = datasourceTerraformModule.id;\n    }\n  } else {\n    logger.debug({ dep }, 'terraform dep has no source');\n    dep.skipReason = SkipReason.NoSource;\n  }\n  /* eslint-enable no-param-reassign */\n}\n"]}