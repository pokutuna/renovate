{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../lib/manager/circleci/extract.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,oEAAsD;AACtD,yCAAsC;AACtC,oEAAsD;AAEtD,mDAA+C;AAE/C,SAAgB,kBAAkB,CAAC,OAAe;IAChD,MAAM,IAAI,GAAwB,EAAE,CAAC;IACrC,IAAI;QACF,MAAM,KAAK,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QAClC,KAAK,IAAI,UAAU,GAAG,CAAC,EAAE,UAAU,GAAG,KAAK,CAAC,MAAM,EAAE,UAAU,IAAI,CAAC,EAAE;YACnE,MAAM,IAAI,GAAG,KAAK,CAAC,UAAU,CAAC,CAAC;YAC/B,MAAM,IAAI,GAAG,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACxC,IAAI,IAAI,EAAE;gBACR,eAAM,CAAC,KAAK,CAAC,wBAAwB,UAAU,EAAE,CAAC,CAAC;gBACnD,IAAI,QAAiB,CAAC;gBACtB,GAAG;oBACD,QAAQ,GAAG,KAAK,CAAC;oBACjB,MAAM,OAAO,GAAG,KAAK,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;oBACtC,eAAM,CAAC,KAAK,CAAC,aAAa,OAAO,GAAG,CAAC,CAAC;oBACtC,MAAM,QAAQ,GAAG,qBAAqB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;oBACrD,IAAI,QAAQ,EAAE;wBACZ,eAAM,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;wBACzB,QAAQ,GAAG,IAAI,CAAC;wBAChB,UAAU,IAAI,CAAC,CAAC;wBAChB,MAAM,OAAO,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;wBAC5B,MAAM,CAAC,OAAO,EAAE,YAAY,CAAC,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;wBACvD,MAAM,GAAG,GAAsB;4BAC7B,OAAO,EAAE,KAAK;4BACd,OAAO;4BACP,YAAY;4BACZ,UAAU,EAAE,aAAa,CAAC,EAAE;4BAC5B,UAAU,EAAE,OAAO;4BACnB,kBAAkB,EAAE,mBAAmB;4BACvC,UAAU,EAAE,aAAa,CAAC,EAAE;4BAC5B,aAAa,EAAE,KAAK;yBACrB,CAAC;wBACF,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;qBAChB;iBACF,QAAQ,QAAQ,EAAE;aACpB;YACD,MAAM,KAAK,GAAG,uCAAuC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACjE,IAAI,KAAK,EAAE;gBACT,MAAM,WAAW,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;gBAC7B,MAAM,GAAG,GAAG,gBAAM,CAAC,WAAW,CAAC,CAAC;gBAChC,eAAM,CAAC,KAAK,CACV;oBACE,OAAO,EAAE,GAAG,CAAC,OAAO;oBACpB,YAAY,EAAE,GAAG,CAAC,YAAY;oBAC9B,aAAa,EAAE,GAAG,CAAC,aAAa;iBACjC,EACD,uBAAuB,CACxB,CAAC;gBACF,GAAG,CAAC,OAAO,GAAG,QAAQ,CAAC;gBACvB,GAAG,CAAC,UAAU,GAAG,QAAQ,CAAC;gBAC1B,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;aAChB;SACF;KACF;IAAC,OAAO,GAAG,EAAE,0BAA0B,CAAC;QACvC,eAAM,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,EAAE,kCAAkC,CAAC,CAAC;KAC1D;IACD,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;QAChB,OAAO,IAAI,CAAC;KACb;IACD,OAAO,EAAE,IAAI,EAAE,CAAC;AAClB,CAAC;AA3DD,gDA2DC","sourcesContent":["import * as datasourceOrb from '../../datasource/orb';\nimport { logger } from '../../logger';\nimport * as npmVersioning from '../../versioning/npm';\nimport { PackageDependency, PackageFile } from '../common';\nimport { getDep } from '../dockerfile/extract';\n\nexport function extractPackageFile(content: string): PackageFile | null {\n  const deps: PackageDependency[] = [];\n  try {\n    const lines = content.split('\\n');\n    for (let lineNumber = 0; lineNumber < lines.length; lineNumber += 1) {\n      const line = lines[lineNumber];\n      const orbs = /^\\s*orbs:\\s*$/.exec(line);\n      if (orbs) {\n        logger.trace(`Matched orbs on line ${lineNumber}`);\n        let foundOrb: boolean;\n        do {\n          foundOrb = false;\n          const orbLine = lines[lineNumber + 1];\n          logger.trace(`orbLine: \"${orbLine}\"`);\n          const orbMatch = /^\\s+([^:]+):\\s(.+)$/.exec(orbLine);\n          if (orbMatch) {\n            logger.trace('orbMatch');\n            foundOrb = true;\n            lineNumber += 1;\n            const depName = orbMatch[1];\n            const [orbName, currentValue] = orbMatch[2].split('@');\n            const dep: PackageDependency = {\n              depType: 'orb',\n              depName,\n              currentValue,\n              datasource: datasourceOrb.id,\n              lookupName: orbName,\n              commitMessageTopic: '{{{depName}}} orb',\n              versioning: npmVersioning.id,\n              rangeStrategy: 'pin',\n            };\n            deps.push(dep);\n          }\n        } while (foundOrb);\n      }\n      const match = /^\\s*- image:\\s*'?\"?([^\\s'\"]+)'?\"?\\s*$/.exec(line);\n      if (match) {\n        const currentFrom = match[1];\n        const dep = getDep(currentFrom);\n        logger.debug(\n          {\n            depName: dep.depName,\n            currentValue: dep.currentValue,\n            currentDigest: dep.currentDigest,\n          },\n          'CircleCI docker image'\n        );\n        dep.depType = 'docker';\n        dep.versioning = 'docker';\n        deps.push(dep);\n      }\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.warn({ err }, 'Error extracting circleci images');\n  }\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}